<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ’ä¸°è´¢åŠ¡ Pro - åŠ³åŠ¡è´¢åŠ¡å…¨èƒ½ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --ios-blue: #007AFF; --ios-green: #34C759; --ios-red: #FF3B30; --ios-orange: #FF9500; --ios-bg: #F2F2F7; --ios-card: #FFFFFF; --text-main: #1C1C1E; --text-sub: #8E8E93; }
        body { background: var(--ios-bg); color: var(--text-main); font-family: -apple-system, system-ui, sans-serif; margin: 0; padding-bottom: 110px; }

        /* ç™»å½• */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; box-sizing: border-box; }
        .login-box { width: 100%; max-width: 340px; }
        .login-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e5e5e5; background: #f9f9f9; font-size: 16px; margin-bottom: 12px; box-sizing: border-box; outline: none; }
        .login-btn { width: 100%; background: var(--ios-blue); color: white; padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 16px; }

        /* å¯¼èˆª */
        .filter-header { padding: 50px 20px 20px; position: sticky; top: 0; background: rgba(242,242,247,0.85); backdrop-filter: blur(20px); z-index: 100; border-bottom: 0.5px solid rgba(0,0,0,0.1); }
        .date-row { display: flex; gap: 8px; margin-top: 15px; }
        .date-box { flex: 1; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 10px; display: flex; flex-direction: column; }
        .date-box label { font-size: 10px; color: var(--text-sub); }
        .date-box input { background: transparent; border: none; font-size: 13px; font-weight: 600; color: var(--ios-blue); outline: none; }

        /* å¡ç‰‡ */
        .hero-card { background: #1c1c1e; color: white; border-radius: 24px; padding: 25px; margin: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .hero-val { font-size: 28px; font-weight: 800; margin: 10px 0; font-family: 'SF Mono'; }
        .container { padding: 0 20px; }
        .ios-card { background: var(--ios-card); border-radius: 18px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        /* è¯¦æƒ…ä¸æŒ‰é’® */
        .sheet { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: none; }
        .sheet-content { position: absolute; bottom: 0; width: 100%; height: 85%; background: var(--ios-bg); border-radius: 25px 25px 0 0; padding: 25px; box-sizing: border-box; overflow-y: auto; }
        .btn-group { display: flex; flex-direction: column; gap: 8px; margin: 15px 0; }
        .btn-blue { background: var(--ios-blue); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 600; width: 100%; }
        
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; font-weight: 800; margin-right: 6px; }
        .tag-inv { background: var(--ios-blue); }
        .tag-pay { background: var(--ios-green); }
        .tag-wage { background: var(--ios-orange); }
        .tag-bonus { background: var(--ios-red); }

        .nav-tab { position: fixed; bottom: 0; width: 100%; height: 84px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); display: flex; padding-bottom: env(safe-area-inset-bottom); border-top: 0.5px solid rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 11px; font-weight: 600; }
        .nav-item.active { color: var(--ios-blue); }

        .page { display: none; } .page.active { display: block; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="text-align: center; margin-bottom: 25px;">æ’ä¸°è´¢åŠ¡äº‘ ç™»å½•</h2>
        <input type="email" id="email" class="login-input" placeholder="é‚®ç®±è´¦å·">
        <input type="password" id="password" class="login-input" placeholder="è®¿é—®å¯†ç ">
        <button class="login-btn" onclick="handleLogin()">ç™»å½•</button>
        <div id="login-msg" style="color:var(--ios-red); text-align:center; margin-top:15px; font-size:14px;"></div>
    </div>
</div>

<div id="app" style="display:none;">
    <div class="filter-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 style="margin:0; font-size: 20px;">æ’ä¸°è´¢åŠ¡äº‘</h1>
            <button style="border:none; background:none; color:var(--ios-red); font-size:13px; font-weight:600;" onclick="handleLogout()">æ³¨é”€</button>
        </div>
        <div class="date-row">
            <div class="date-box"><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="start-date" onchange="renderAll()"></div>
            <div class="date-box"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="end-date" onchange="renderAll()"></div>
        </div>
    </div>

    <section id="home" class="page active">
        <div class="hero-card">
            <div style="font-size: 12px; opacity: 0.7;">å‡€ç»“ä½™ (CNY)</div>
            <div class="hero-val" id="profit-val">Â¥ 0.00</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:10px; font-size:13px;">
                <div>æ€»åº”æ”¶:<br><b id="sum-ar">0</b></div>
                <div>å·¥èµ„/å¥–é‡‘æ”¯å‡º:<br><b id="sum-wages" style="color:var(--ios-red)">0</b></div>
            </div>
        </div>
        <div class="container">
            <div class="ios-card" onclick="addWorker()" style="border: 1px dashed var(--ios-blue); color: var(--ios-blue); font-weight: bold; justify-content: center;">
                <span>+ æ–°å¢å·¥äººæ¡£æ¡ˆ</span>
            </div>
            <div class="ios-card" onclick="document.getElementById('file-up').click()">
                <div><b>åŒæ­¥å‘ç¥¨ Excel</b></div>
                <input type="file" id="file-up" hidden onchange="handleExcel(this)">
                <span>ğŸ“‚</span>
            </div>
        </div>
    </section>

    <section id="income" class="page"><div class="container" id="list-income"></div></section>
    <section id="vendor" class="page"><div class="container" id="list-vendor"></div></section>
    <section id="worker" class="page"><div class="container" id="list-worker"></div></section>

    <div id="sheet" class="sheet" onclick="if(event.target===this)this.style.display='none'">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div id="sheet-header"></div>
            <div id="sheet-body"></div>
        </div>
    </div>

    <nav class="nav-tab">
        <div class="nav-item active" onclick="switchTab('home', this)">ğŸ  æ€»è§ˆ</div>
        <div class="nav-item" onclick="switchTab('income', this)">ğŸ’° å®¢æˆ·</div>
        <div class="nav-item" onclick="switchTab('vendor', this)">ğŸ“‰ ä¾›åº”å•†</div>
        <div class="nav-item" onclick="switchTab('worker', this)">ğŸ‘· å·¥äººå·¥èµ„</div>
    </nav>
</div>

<script>
    const S_URL = "https://vjelnswcmypvypegqxrb.supabase.co";
    const S_KEY = "sb_publishable_BUhR8WlHyaOHnK5IjEGKtw_lcre2gFT";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let db = { invs:[], vInvs:[], pays:[], vPays:[], workers:[], wageLogs:[] };

    window.onload = async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) showApp();
    };

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) document.getElementById('login-msg').innerText = "ç™»å½•å¤±è´¥: " + error.message;
        else showApp();
    }

    async function handleLogout() { await supabaseClient.auth.signOut(); location.reload(); }

    function showApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        loadData();
    }

    async function loadData() {
        const fetch = async (tbl) => (await supabaseClient.from(tbl).select('*')).data || [];
        db.invs = await fetch('invoices'); db.pays = await fetch('payments');
        db.vInvs = await fetch('vendor_invoices'); db.vPays = await fetch('vendor_payments');
        db.workers = await fetch('workers'); // éœ€è¦åœ¨Supabaseæ–°å»ºæ­¤è¡¨: id, name, hourly_rate
        db.wageLogs = await fetch('wage_logs'); // éœ€è¦åœ¨Supabaseæ–°å»ºæ­¤è¡¨: id, worker_name, amount, type(å·¥æ—¶/å¥–é‡‘/åˆ†çº¢), work_hours, log_date
        renderAll();
    }

    function filterData(list, key) {
        const sVal = document.getElementById('start-date').value;
        const eVal = document.getElementById('end-date').value;
        if (!sVal && !eVal) return list;
        const s = new Date(sVal || "1970-01-01");
        const e = new Date(eVal || "2099-12-31");
        e.setHours(23, 59, 59);
        return list.filter(i => {
            const d = new Date(i[key] || i.log_date || i.inv_date || i.pay_date || i.created_at);
            return d >= s && d <= e;
        });
    }

    function renderAll() {
        const f_invs = filterData(db.invs, 'inv_date');
        const f_pays = filterData(db.pays, 'pay_date');
        const f_vInvs = filterData(db.vInvs, 'inv_date');
        const f_vPays = filterData(db.vPays, 'pay_date');
        const f_wages = filterData(db.wageLogs, 'log_date');

        const ar = f_invs.reduce((a,b)=>a+b.amount,0) - f_pays.reduce((a,b)=>a+b.amount,0);
        const ap = f_vInvs.reduce((a,b)=>a+b.amount,0) - f_vPays.reduce((a,b)=>a+b.amount,0);
        const wagesTotal = f_wages.reduce((a,b)=>a+b.amount,0);

        document.getElementById('profit-val').innerText = `Â¥ ${(ar - ap - wagesTotal).toLocaleString(undefined, {minimumFractionDigits:2})}`;
        document.getElementById('sum-ar').innerText = `Â¥${ar.toLocaleString()}`;
        document.getElementById('sum-wages').innerText = `Â¥${wagesTotal.toLocaleString()}`;

        renderSortedList('list-income', db.invs, db.pays, 'client_name', 'invoices', 'payments', f_invs, f_pays);
        renderSortedList('list-vendor', db.vInvs, db.vPays, 'vendor_name', 'vendor_invoices', 'vendor_payments', f_vInvs, f_vPays);
        renderWorkerList(f_wages);
    }

    function renderSortedList(target, rawInvs, rawPays, key, t1, t2, fInvs, fPays) {
        const container = document.getElementById(target);
        container.innerHTML = `<h3 style="margin:20px 0 10px;">ä¸šåŠ¡å¯¹è´¦å•</h3>`;
        const names = [...new Set(rawInvs.map(i=>i[key]))].filter(Boolean);
        names.map(name => {
            const total = fInvs.filter(i=>i[key]===name).reduce((s,i)=>s+i.amount,0);
            const paid = fPays.filter(p=>p[key]===name).reduce((s,p)=>s+p.amount,0);
            return { name, total, diff: total - paid };
        })
        .sort((a,b)=>b.diff - a.diff)
        .forEach(item => {
            if(item.total === 0 && item.diff === 0) return;
            container.innerHTML += `<div class="ios-card" onclick="showSheet('${item.name}', '${key}', '${t1}', '${t2}')">
                <div><b>${item.name}</b><div style="font-size:11px; color:#8e8e93">æœŸé—´æµæ°´: Â¥${item.total.toLocaleString()}</div></div>
                <div style="font-family:'SF Mono'; font-weight:700; color:${item.diff>0?'#FF3B30':'#34C759'}">Â¥${item.diff.toLocaleString(undefined,{minimumFractionDigits:2})}</div>
            </div>`;
        });
    }

    // å·¥äººåˆ—è¡¨æ¸²æŸ“
    function renderWorkerList(fWages) {
        const container = document.getElementById('list-worker');
        container.innerHTML = `<h3 style="margin:20px 0 10px;">å·¥äººè–ªèµ„ç»Ÿè®¡</h3>`;
        db.workers.forEach(w => {
            const myWages = fWages.filter(log => log.worker_name === w.name);
            const total = myWages.reduce((s,l)=>s+l.amount,0);
            container.innerHTML += `<div class="ios-card" onclick="showWorkerSheet('${w.name}', ${w.hourly_rate})">
                <div><b>${w.name}</b><div style="font-size:11px; color:#8e8e93">æ—¶è–ª: Â¥${w.hourly_rate}</div></div>
                <div style="font-family:'SF Mono'; font-weight:700; color:var(--ios-red)">Â¥${total.toLocaleString()}</div>
            </div>`;
        });
    }

    // å·¥äººè¯¦æƒ…å¼¹çª—
    async function showWorkerSheet(name, rate) {
        const sheet = document.getElementById('sheet'); sheet.style.display = 'block';
        document.getElementById('sheet-header').innerHTML = `
            <h2>${name} (Â¥${rate}/å°æ—¶)</h2>
            <div class="btn-group">
                <button class="btn-blue" onclick="logWork('${name}', ${rate})">ç™»è®°å·¥æ—¶ (è‡ªåŠ¨ç®—è–ª)</button>
                <button class="btn-blue" style="background:var(--ios-orange)" onclick="logBonus('${name}', 'å¥–é‡‘')">ç™»è®°å¥–é‡‘</button>
                <button class="btn-blue" style="background:var(--ios-red)" onclick="logBonus('${name}', 'åˆ†çº¢')">ç™»è®°åˆ†çº¢</button>
            </div>`;
        const {data} = await supabaseClient.from('wage_logs').select('*').eq('worker_name', name).order('log_date', {ascending:false});
        let html = '';
        data.forEach(l => {
            const tagClass = l.type === 'å·¥æ—¶' ? 'tag-wage' : 'tag-bonus';
            html += `<div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:0.5px solid #eee">
                <div><span class="tag ${tagClass}">${l.type}</span><span style="font-size:13px; font-weight:600;">${l.log_date}</span>
                <div style="font-size:11px; color:#8e8e93">${l.work_hours ? l.work_hours+'å°æ—¶' : l.type}</div></div>
                <div style="text-align:right"><div style="font-family:'SF Mono'; font-weight:700;">Â¥${l.amount.toLocaleString()}</div>
                <button style="border:none; background:none; color:red; font-size:10px;" onclick="deleteRec('${l.id}','wage_logs')">åˆ é™¤</button></div>
            </div>`;
        });
        document.getElementById('sheet-body').innerHTML = html || '<p style="text-align:center; color:#999;">æš‚æ— è®°å½•</p>';
    }

    // åŠ³åŠ¡åŠŸèƒ½å‡½æ•°
    async function addWorker() {
        const name = prompt("å·¥äººå§“å:"); if(!name) return;
        const rate = prompt("æ—¶è–ª (å…ƒ/å°æ—¶):", "20"); if(!rate) return;
        await supabaseClient.from('workers').insert({ name, hourly_rate: parseFloat(rate) });
        loadData();
    }

    async function logWork(name, rate) {
        const date = prompt("ä¸Šç­æ—¥æœŸ (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
        const hours = prompt("ä¸Šç­æ—¶é•¿ (å°æ—¶):"); if(!hours) return;
        const amount = parseFloat(hours) * rate;
        await supabaseClient.from('wage_logs').insert({ worker_name: name, amount, type: 'å·¥æ—¶', work_hours: parseFloat(hours), log_date: date });
        loadData(); document.getElementById('sheet').style.display='none';
    }

    async function logBonus(name, type) {
        const date = prompt("æ—¥æœŸ (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
        const amount = prompt(type + "é‡‘é¢:"); if(!amount) return;
        await supabaseClient.from('wage_logs').insert({ worker_name: name, amount: parseFloat(amount), type: type, log_date: date });
        loadData(); document.getElementById('sheet').style.display='none';
    }

    // åŸæœ‰ä¸šåŠ¡å‡½æ•° (ä¿æŒå…¨é‡ + è¡¥å½•)
    async function quickPay(n, c, t) {
        const date = prompt("äº¤æ˜“æ—¥æœŸ:", new Date().toISOString().split('T')[0]);
        const amt = prompt("é‡‘é¢:"); if(!amt) return;
        await supabaseClient.from(t).insert({ [c]: n, amount: parseFloat(amt), pay_date: date });
        loadData(); document.getElementById('sheet').style.display='none';
    }

    async function manualFix(n, c, t) {
        const date = prompt("å‘ç¥¨/è°ƒè´¦æ—¥æœŸ:", new Date().toISOString().split('T')[0]);
        const amt = prompt("é‡‘é¢:");
        const num = prompt("å‘ç¥¨å·ç /å¤‡æ³¨:"); if(!amt) return;
        await supabaseClient.from(t).insert({ [c]: n, amount: parseFloat(amt), inv_date: date, invoice_num: num || 'æ‰‹å·¥è¡¥å½•' });
        loadData(); document.getElementById('sheet').style.display='none';
    }

    async function showSheet(name, keyCol, t1, t2) {
        const sheet = document.getElementById('sheet'); sheet.style.display = 'block';
        document.getElementById('sheet-header').innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;"><h2>${name}</h2>
            <button style="color:red; background:none; border:none; font-size:12px;" onclick="deleteEntity('${name}','${keyCol}','${t1}','${t2}')">åˆ é™¤å•ä½</button></div>
            <div class="btn-group">
                <button class="btn-blue" onclick="quickPay('${name}','${keyCol}','${t2}')">ç™»è®°å›æ¬¾/æ”¯ä»˜</button>
                <button class="btn-blue" style="background:#8E8E93" onclick="manualFix('${name}','${keyCol}','${t1}')">è¡¥å½•å‘ç¥¨/è°ƒè´¦</button>
            </div>`;
        const {data:d1} = await supabaseClient.from(t1).select('*').eq(keyCol, name);
        const {data:d2} = await supabaseClient.from(t2).select('*').eq(keyCol, name);
        const list = [...(d1||[]).map(x=>({...x,tag:'å‘ç¥¨',c:'tag-inv'})), ...(d2||[]).map(x=>({...x,tag:'æ¬¾é¡¹',c:'tag-pay'}))].sort((a,b)=>new Date(b.inv_date||b.pay_date||b.created_at) - new Date(a.inv_date||a.pay_date||a.created_at));
        let html = '';
        list.forEach(item => {
            html += `<div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:0.5px solid #eee">
                <div><span class="tag ${item.c}">${item.tag}</span><span style="font-size:13px; font-weight:600;">${item.inv_date||item.pay_date||''}</span>
                <div style="font-size:11px; color:#8e8e93">å•å·: ${item.invoice_num || 'æ— '}</div></div>
                <div style="text-align:right"><div style="font-family:'SF Mono'; font-weight:700;">Â¥${(item.amount||0).toLocaleString()}</div>
                <button style="border:none; background:none; color:red; font-size:10px;" onclick="deleteRec('${item.id}','${item.tag==='å‘ç¥¨'?t1:t2}')">åˆ é™¤</button></div>
            </div>`;
        });
        document.getElementById('sheet-body').innerHTML = html || '<p style="text-align:center; color:#999;">æ— è®°å½•</p>';
    }

    async function handleExcel(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const upInvs = [], upVInvs = [];
            json.forEach(r => {
                const item = { invoice_num: String(r['æ•°ç”µå‘ç¥¨å·ç ']||''), amount: parseFloat(r['ä»·ç¨åˆè®¡']||0), inv_date: String(r['å¼€ç¥¨æ—¥æœŸ']||'') };
                if(String(r['é”€æ–¹åç§°']).includes('æ’ä¸°')) { item.client_name = r['è´­ä¹°æ–¹åç§°']; upInvs.push(item); }
                else { item.vendor_name = r['é”€æ–¹åç§°']; upVInvs.push(item); }
            });
            await supabaseClient.from('invoices').upsert(upInvs, {onConflict:'invoice_num'});
            await supabaseClient.from('vendor_invoices').upsert(upVInvs, {onConflict:'invoice_num'});
            alert("å¯¼å…¥æˆåŠŸ"); loadData();
        };
        reader.readAsArrayBuffer(file);
    }

    function switchTab(id, el) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active'); el.classList.add('active');
        renderAll();
    }

    async function deleteRec(id,tbl){ if(confirm("åˆ é™¤ï¼Ÿ")){ await supabaseClient.from(tbl).delete().eq('id',id); loadData(); document.getElementById('sheet').style.display='none'; }}
    async function deleteEntity(n,k,t1,t2){ if(confirm("åˆ é™¤å•ä½ï¼Ÿ")){ await supabaseClient.from(t1).delete().eq(k,n); await supabaseClient.from(t2).delete().eq(k,n); loadData(); document.getElementById('sheet').style.display='none'; }}
</script>
</body>
</html>
