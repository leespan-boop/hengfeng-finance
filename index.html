<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ’ä¸°è´¢åŠ¡ Pro - å…¨æƒç®¡ç†ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --ios-bg: #F2F2F7; --ios-card: #FFFFFF; --ios-blue: #007AFF; --ios-green: #34C759; --ios-red: #FF3B30; --ios-text: #000000; --ios-sub: #8E8E93; --ios-border: rgba(0,0,0,0.05); }
        body { background: var(--ios-bg); color: var(--ios-text); font-family: -apple-system, system-ui, sans-serif; margin: 0; padding-bottom: 90px; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .page { display: none; } .page.active { display: block; }
        .header { padding: 40px 20px 10px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--ios-bg); z-index: 100; }
        .header h1 { font-size: 30px; margin: 0; letter-spacing: -1px; }
        
        /* çœ‹æ¿ */
        .main-card { background: #1c1c1e; color: white; border-radius: 20px; padding: 24px; margin: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .val { font-size: 32px; font-weight: 700; margin: 10px 0; font-family: 'SF Mono'; }

        /* åˆ—è¡¨å¡ç‰‡ */
        .card { background: var(--ios-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); border: 0.5px solid var(--ios-border); transition: transform 0.1s; }
        .card:active { transform: scale(0.98); }
        .info { flex: 1; }
        .name { font-weight: 600; font-size: 16px; }
        .sub { font-size: 12px; color: var(--ios-sub); margin-top: 2px; }
        .money { font-family: 'SF Mono'; font-weight: 700; text-align: right; }

        /* æŠ½å±‰ */
        .drawer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: none; }
        .drawer-content { position: absolute; bottom: 0; width: 100%; height: 85%; background: var(--ios-bg); border-radius: 25px 25px 0 0; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        
        /* æŒ‰é’® */
        .btn-ios { background: var(--ios-blue); color: white; border: none; padding: 10px 18px; border-radius: 12px; font-weight: 600; font-size: 14px; }
        .btn-action { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; margin-top: 10px; font-size: 15px; }
        .btn-del { color: var(--ios-red); background: #FFEBEB; padding: 8px 12px; border-radius: 8px; border: none; font-size: 12px; font-weight: 600; }
        
        /* å¯¼èˆª */
        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 84px; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; border-top: 0.5px solid var(--ios-border); padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .tab-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--ios-sub); font-size: 10px; }
        .tab-btn.active { color: var(--ios-blue); }
        .tab-btn i { font-size: 22px; margin-bottom: 4px; }

        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        .tag-blue { background: #E3F2FD; color: var(--ios-blue); }
        .tag-green { background: #E8F5E9; color: var(--ios-green); }
    </style>
</head>
<body>

<div id="app">
    <section id="home" class="page active">
        <div class="header"><h1>æ’ä¸°æ§åˆ¶å°</h1></div>
        <div class="main-card">
            <div style="font-size: 12px; opacity: 0.7;">å‡€æ”¶æ”¯ç›ˆä½™ (CNY)</div>
            <div class="val" id="total-profit">Â¥ 0.00</div>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 11px; margin-top: 15px; opacity: 0.9;">
                <div>å®¢æˆ·æ¬ æ¬¾: <b id="ar-sum">0</b></div>
                <div>ä¾›åº”å•†æ¬ æ¬¾: <b id="ap-sum">0</b></div>
                <div>å·¥äººå¾…å‘: <b id="wg-sum">0</b></div>
            </div>
        </div>
        <div class="container">
            <div class="card" style="border: 1px dashed var(--ios-blue);">
                <h3 style="margin-top:0">å¯¼å…¥æ•°æ®</h3>
                <input type="file" id="excel-up" hidden onchange="handleExcel(this)">
                <button class="btn-action" style="background: var(--ios-blue); color:white;" onclick="document.getElementById('excel-up').click()">ğŸ“¥ å¯¼å…¥ç¨åŠ¡å‘ç¥¨ Excel</button>
            </div>
        </div>
    </section>

    <section id="income" class="page">
        <div class="header"><h1>å®¢æˆ·ç®¡ç†</h1><button class="btn-ios" onclick="manualAdd('client_name')">+ å¢åŠ </button></div>
        <div class="container" id="list-income"></div>
    </section>

    <section id="vendor" class="page">
        <div class="header"><h1>ä¾›åº”å•†ç®¡ç†</h1><button class="btn-ios" onclick="manualAdd('vendor_name')">+ å¢åŠ </button></div>
        <div class="container" id="list-vendor"></div>
    </section>

    <section id="worker" class="page">
        <div class="header"><h1>å·¥äººå·¥èµ„</h1><button class="btn-ios" onclick="manualAdd('worker')">+ å¢åŠ </button></div>
        <div class="container" id="list-worker"></div>
    </section>

    <div id="drawer" class="drawer" onclick="if(event.target==this)this.style.display='none'">
        <div class="drawer-content" onclick="event.stopPropagation()">
            <div id="drawer-header"></div>
            <div id="drawer-body"></div>
        </div>
    </div>
</div>

<nav class="tab-bar">
    <div class="tab-btn active" onclick="switchTab('home', this)"><i>ğŸ </i>æ€»è§ˆ</div>
    <div class="tab-btn" onclick="switchTab('income', this)"><i>ğŸ’°</i>å®¢æˆ·</div>
    <div class="tab-btn" onclick="switchTab('vendor', this)"><i>ğŸ“‰</i>ä¾›åº”å•†</div>
    <div class="tab-btn" onclick="switchTab('worker', this)"><i>ğŸ‘·</i>å·¥äºº</div>
</nav>

<script>
    const S_URL = "https://vjelnswcmypvypegqxrb.supabase.co";
    const S_KEY = "sb_publishable_BUhR8WlHyaOHnK5IjEGKtw_lcre2gFT";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let db = { invs:[], vInvs:[], pays:[], vPays:[], workers:[], wLogs:[], wPays:[] };

    function switchTab(id, el) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        loadData();
    }

    async function loadData() {
        const fetch = async (tbl) => (await supabaseClient.from(tbl).select('*')).data || [];
        db.invs = await fetch('invoices'); db.pays = await fetch('payments');
        db.vInvs = await fetch('vendor_invoices'); db.vPays = await fetch('vendor_payments');
        db.workers = await fetch('workers'); db.wLogs = await fetch('work_logs'); db.wPays = await fetch('worker_payments');
        renderAll();
    }

    function renderAll() {
        const ar = db.invs.reduce((a,b)=>a+b.amount,0) - db.pays.reduce((a,b)=>a+b.amount,0);
        const ap = db.vInvs.reduce((a,b)=>a+b.amount,0) - db.vPays.reduce((a,b)=>a+b.amount,0);
        let wgArrears = 0;
        db.workers.forEach(w => {
            const earned = db.wLogs.filter(l=>l.worker_name===w.name).reduce((a,b)=>a+b.hours,0) * w.hourly_rate;
            const paid = db.wPays.filter(p=>p.worker_name===w.name).reduce((a,b)=>a+b.amount,0);
            wgArrears += (earned - paid);
        });

        document.getElementById('total-profit').innerText = `Â¥ ${(ar - ap - wgArrears).toLocaleString()}`;
        document.getElementById('ar-sum').innerText = `Â¥${ar.toFixed(0)}`;
        document.getElementById('ap-sum').innerText = `Â¥${ap.toFixed(0)}`;
        document.getElementById('wg-sum').innerText = `Â¥${wgArrears.toFixed(0)}`;

        renderCategoryList('list-income', db.invs, db.pays, 'client_name', 'invoices', 'payments');
        renderCategoryList('list-vendor', db.vInvs, db.vPays, 'vendor_name', 'vendor_invoices', 'vendor_payments');
        renderWorkerList();
    }

    function renderCategoryList(target, items, pays, key, tblInv, tblPay) {
        const names = [...new Set(items.map(i=>i[key]))];
        const container = document.getElementById(target);
        container.innerHTML = '';
        names.sort((a,b)=> {
            const bal = (name) => items.filter(i=>i[key]===name).reduce((s,i)=>s+i.amount,0) - pays.filter(p=>p[key]===name).reduce((s,p)=>s+p.amount,0);
            return bal(b) - bal(a);
        }).forEach(name => {
            const total = items.filter(i=>i[key]===name).reduce((s,i)=>s+i.amount,0);
            const paid = pays.filter(p=>p[key]===name).reduce((s,p)=>s+p.amount,0);
            const diff = total - paid;
            container.innerHTML += `
                <div class="card" onclick="showDetail('${name}', '${key}', '${tblInv}', '${tblPay}')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="info"><div class="name">${name}</div><div class="sub">å·²ç»“:Â¥${paid.toFixed(0)} / æ€»é¢:Â¥${total.toFixed(0)}</div></div>
                        <div class="money" style="color:${diff>0?'var(--ios-red)':'var(--ios-green)'}">Â¥${diff.toFixed(0)}</div>
                    </div>
                </div>`;
        });
    }

    async function showDetail(name, keyCol, tblInv, tblPay) {
        const drawer = document.getElementById('drawer');
        drawer.style.display = 'block';
        document.getElementById('drawer-header').innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <h2>${name}</h2>
                <button class="btn-del" onclick="deleteEntireEntity('${name}','${keyCol}','${tblInv}','${tblPay}')">å½»åº•åˆ é™¤è¯¥å•ä½</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-ios" style="flex:1" onclick="quickPay('${name}','${keyCol}','${tblPay}')">è®°æ¬¾é¡¹</button>
                <button class="btn-ios" style="flex:1; background:#8E8E93" onclick="manualFix('${name}','${keyCol}','${tblInv}')">æ‰‹åŠ¨æ ¡å‡†</button>
            </div>`;

        const {data:invs} = await supabaseClient.from(tblInv).select('*').eq(keyCol, name);
        const {data:pays} = await supabaseClient.from(tblPay).select('*').eq(keyCol, name);

        let html = '<h3 style="margin-top:25px;">å¾€æ¥æµæ°´</h3>';
        [...(invs||[]).map(x=>({...x,type:'é¡¹ç›®'})), ...(pays||[]).map(x=>({...x,type:'æ¬¾é¡¹'}))]
        .sort((a,b)=>new Date(b.created_at || b.inv_date)-new Date(a.created_at || a.inv_date))
        .forEach(item => {
            html += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:0.5px solid var(--ios-border);">
                    <div>
                        <span class="tag ${item.type==='é¡¹ç›®'?'tag-blue':'tag-green'}">${item.type}</span>
                        <span style="font-size:13px; color:var(--ios-sub)">${item.inv_date || item.pay_date || ''}</span>
                        <div style="font-size:11px; margin-top:2px;">${item.invoice_num || item.remark || 'æ— å¤‡æ³¨'}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-family:'SF Mono'; font-weight:700;">Â¥${item.amount.toFixed(2)}</div>
                        <button style="color:var(--ios-red); border:none; background:none; font-size:11px;" onclick="deleteSingleRec('${item.id}','${item.type==='é¡¹ç›®'?tblInv:tblPay}')">åˆ é™¤è®°å½•</button>
                    </div>
                </div>`;
        });
        document.getElementById('drawer-body').innerHTML = html;
    }

    async function deleteEntireEntity(name, keyCol, t1, t2) {
        if(confirm(`è­¦å‘Šï¼šå°†å½»åº•åˆ é™¤â€œ${name}â€åŠå…¶æ‰€æœ‰ç›¸å…³çš„å¼€ç¥¨å’Œå›æ¬¾è®°å½•ï¼æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
            await supabaseClient.from(t1).delete().eq(keyCol, name);
            await supabaseClient.from(t2).delete().eq(keyCol, name);
            document.getElementById('drawer').style.display='none'; loadData();
        }
    }

    async function deleteSingleRec(id, table) {
        if(confirm("ç¡®å®šåˆ é™¤è¿™ç¬”å•é¡¹è®°å½•å—ï¼Ÿ")) {
            await supabaseClient.from(table).delete().eq('id', id);
            document.getElementById('drawer').style.display='none'; loadData();
        }
    }

    async function manualAdd(type) {
        const name = prompt("è¯·è¾“å…¥åç§°:");
        if(!name) return;
        if(type === 'worker') {
            const rate = prompt("è¯·è¾“å…¥æ—¶è–ª:");
            await supabaseClient.from('workers').upsert({name, hourly_rate: parseFloat(rate)});
        } else {
            const amt = prompt("è¯·è¾“å…¥åˆå§‹æ¬ æ¬¾/ä½™é¢ (æ²¡æœ‰å¡«0):");
            const tbl = type === 'client_name' ? 'invoices' : 'vendor_invoices';
            await supabaseClient.from(tbl).insert({ [type]: name, amount: parseFloat(amt||0), invoice_num: 'åˆå§‹åˆ›å»º-' + Date.now() });
        }
        loadData();
    }

    // å·¥äººéƒ¨åˆ†å¤ç”¨é€»è¾‘
    function renderWorkerList() {
        const container = document.getElementById('list-worker');
        container.innerHTML = '';
        db.workers.forEach(w => {
            const hours = db.wLogs.filter(l=>l.worker_name===w.name).reduce((a,b)=>a+b.hours,0);
            const paid = db.wPays.filter(p=>p.worker_name===w.name).reduce((a,b)=>a+b.amount,0);
            const due = (hours * w.hourly_rate) - paid;
            container.innerHTML += `<div class="card" onclick="showWorkerDetail('${w.name}')">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="info"><div class="name">${w.name}</div><div class="sub">${w.hourly_rate}å…ƒ/æ—¶ | å·²ä»˜:Â¥${paid.toFixed(0)}</div></div>
                    <div class="money" style="color:var(--ios-red)">Â¥${due.toFixed(0)}</div>
                </div>
            </div>`;
        });
    }

    async function showWorkerDetail(name) {
        const drawer = document.getElementById('drawer');
        drawer.style.display = 'block';
        document.getElementById('drawer-header').innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <h2>${name}</h2>
                <button class="btn-del" onclick="deleteEntireEntity('${name}','worker_name','work_logs','worker_payments'); supabaseClient.from('workers').delete().eq('name','${name}').then(()=>loadData());">å½»åº•åˆ é™¤å·¥äºº</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-ios" style="flex:1" onclick="addWLog('${name}')">è®°å·¥æ—¶</button>
                <button class="btn-ios" style="flex:1; background:var(--ios-green)" onclick="addWPay('${name}')">å‘å·¥èµ„</button>
            </div>`;
        const logs = db.wLogs.filter(l=>l.worker_name===name);
        const pays = db.wPays.filter(p=>p.worker_name===name);
        let html = '<h3 style="margin-top:25px;">å·¥èµ„æ˜ç»†</h3>';
        [...logs.map(l=>({...l,type:'å·¥æ—¶'})), ...pays.map(p=>({...p,type:'æ¬¾é¡¹'}))].forEach(item => {
            html += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:0.5px solid #eee;">
                <div><b>${item.type}</b> <small>${item.hours ? item.hours+'h' : 'Â¥'+item.amount}</small></div>
                <button style="border:none; color:red; background:none;" onclick="deleteSingleRec('${item.id}','${item.type==='å·¥æ—¶'?'work_logs':'worker_payments'}')">åˆ é™¤</button>
            </div>`;
        });
        document.getElementById('drawer-body').innerHTML = html;
    }

    // è¾…åŠ©å‡½æ•°
    async function handleExcel(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const upInvs = [], upVInvs = [];
            json.forEach(r => {
                const item = { invoice_num: String(r['æ•°ç”µå‘ç¥¨å·ç ']||''), amount: parseFloat(r['ä»·ç¨åˆè®¡']||0), inv_date: String(r['å¼€ç¥¨æ—¥æœŸ']||'') };
                if(String(r['é”€æ–¹åç§°']).includes('æ’ä¸°')) { item.client_name = r['è´­ä¹°æ–¹åç§°']; upInvs.push(item); }
                else { item.vendor_name = r['é”€æ–¹åç§°']; upVInvs.push(item); }
            });
            if(upInvs.length) await supabaseClient.from('invoices').upsert(upInvs, {onConflict:'invoice_num'});
            if(upVInvs.length) await supabaseClient.from('vendor_invoices').upsert(upVInvs, {onConflict:'invoice_num'});
            alert("åŒæ­¥å®Œæˆï¼"); loadData();
        };
        reader.readAsArrayBuffer(file);
    }
    async function quickPay(n,c,t){ const a=prompt("é‡‘é¢:"); if(a) await supabaseClient.from(t).insert({[c]:n,amount:parseFloat(a)}); loadData(); document.getElementById('drawer').style.display='none'; }
    async function manualFix(n,c,t){ const a=prompt("æ ¡å‡†é‡‘é¢(æ­£åŠ è´Ÿå‡):"); if(a) await supabaseClient.from(t).insert({[c]:n,amount:parseFloat(a),invoice_num:'æ ¡å‡†-'+Date.now()}); loadData(); document.getElementById('drawer').style.display='none'; }
    async function addWLog(n){ const h=prompt("å·¥æ—¶:"); if(h) await supabaseClient.from('work_logs').insert({worker_name:n,hours:parseFloat(h)}); loadData(); document.getElementById('drawer').style.display='none'; }
    async function addWPay(n){ const a=prompt("é‡‘é¢:"); if(a) await supabaseClient.from('worker_payments').insert({worker_name:n,amount:parseFloat(a)}); loadData(); document.getElementById('drawer').style.display='none'; }

    window.onload = loadData;
</script>
</body>
</html>
