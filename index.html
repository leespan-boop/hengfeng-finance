<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ’ä¸°è´¢åŠ¡äº‘ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-text: #000000;
            --ios-sub: #8E8E93;
        }

        body {
            background-color: var(--ios-bg);
            color: var(--ios-text);
            font-family: -apple-system, SF Pro Display, Helvetica Neue, Arial, sans-serif;
            margin: 0;
            padding: 0;
            -webkit-user-select: none;
            overscroll-behavior-y: contain;
        }

        /* é¡¶éƒ¨å¤§æ ‡é¢˜ */
        .header-container {
            padding: 60px 20px 20px;
            background: var(--ios-bg);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-container h1 { font-size: 34px; font-weight: 700; margin: 0; letter-spacing: -1px; }
        .header-container p { color: var(--ios-sub); margin: 5px 0 0; font-size: 15px; }

        /* æ ¸å¿ƒçœ‹æ¿å¡ç‰‡ */
        .dash-card {
            background: linear-gradient(135deg, #1c1c1e, #2c2c2e);
            border-radius: 24px;
            padding: 24px;
            margin: 0 20px 25px;
            color: white;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        .dash-label { font-size: 13px; opacity: 0.6; font-weight: 600; text-transform: uppercase; }
        .dash-value { font-size: 36px; font-weight: 700; margin: 8px 0; font-family: 'SF Mono', monospace; }

        /* åŠŸèƒ½å¡ç‰‡ */
        .section-title { padding: 0 25px; font-size: 20px; font-weight: 600; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .card-list { padding: 0 20px; }
        .item-card {
            background: var(--ios-card);
            border-radius: 18px;
            padding: 18px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            transition: all 0.2s;
        }
        .item-card:active { transform: scale(0.97); background: #F9F9F9; }
        .item-info .name { font-size: 17px; font-weight: 600; margin-bottom: 4px; }
        .item-info .sub { font-size: 13px; color: var(--ios-sub); }
        .item-money { text-align: right; }
        .item-money .amt { font-size: 17px; font-weight: 700; font-family: 'SF Mono'; }
        .item-money .status { font-size: 11px; font-weight: 600; margin-top: 4px; padding: 2px 6px; border-radius: 4px; display: inline-block; }

        /* åº•éƒ¨æ¯›ç»ç’ƒå¯¼èˆª */
        .nav-tab {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 88px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            border-top: 0.5px solid rgba(0,0,0,0.1);
            padding-bottom: 20px;
        }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--ios-sub); font-size: 10px; font-weight: 500; }
        .nav-btn.active { color: var(--ios-blue); }
        .nav-btn i { font-size: 24px; margin-bottom: 4px; }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; align-items: flex-end;
        }
        .modal-content {
            background: white; width: 100%; border-radius: 25px 25px 0 0;
            padding: 30px 20px; box-sizing: border-box; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .ios-input { width: 100%; background: #F2F2F7; border: none; padding: 15px; border-radius: 12px; margin-bottom: 15px; font-size: 16px; outline: none; }
        .ios-btn { width: 100%; background: var(--ios-blue); color: white; border: none; padding: 16px; border-radius: 14px; font-size: 17px; font-weight: 600; }

        .badge-red { background: #FFEBEE; color: var(--ios-red); }
        .badge-green { background: #E8F5E9; color: var(--ios-green); }

        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>

    <div id="app">
        <section id="page-home" class="page active">
            <div class="header-container">
                <h1>æ’ä¸° Pro</h1>
                <p id="date-display">2026å¹´2æœˆ11æ—¥ æ˜ŸæœŸä¸‰</p>
            </div>

            <div class="dash-card">
                <div class="dash-label">å‡€èµ„äº§ä½™é‡ (CNY)</div>
                <div class="dash-value" id="main-balance">Â¥ 0.00</div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px; opacity: 0.8; font-size: 12px;">
                    <span>æ€»åº”æ”¶: <b id="total-ar">Â¥0</b></span>
                    <span>æ€»æ¬ ä»˜: <b id="total-ap">Â¥0</b></span>
                </div>
            </div>

            <div class="section-title">å¿«æ·å·¥å…·</div>
            <div class="card-list">
                <div class="item-card" onclick="document.getElementById('excel-file').click()">
                    <div class="item-info">
                        <div class="name">åŒæ­¥ç¨åŠ¡ Excel</div>
                        <div class="sub">è‡ªåŠ¨è¯†åˆ«æ”¶å…¥/æˆæœ¬å‘ç¥¨</div>
                    </div>
                    <div style="font-size: 24px;">ğŸ“¥</div>
                </div>
                <input type="file" id="excel-file" hidden onchange="handleExcelImport(this)">
            </div>
        </section>

        <section id="page-client" class="page">
            <div class="header-container"><h1>å®¢æˆ·å¯¹è´¦</h1></div>
            <div class="card-list" id="client-list-render"></div>
        </section>

        <section id="page-vendor" class="page">
            <div class="header-container"><h1>ä¾›åº”å•†æˆæœ¬</h1></div>
            <div class="card-list" id="vendor-list-render"></div>
        </section>

        <section id="page-worker" class="page">
            <div class="header-container">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h1>å·¥äººå·¥èµ„</h1>
                    <button class="ios-btn" style="width:auto; padding:8px 15px;" onclick="openWorkerModal()">æ·»åŠ å·¥äºº</button>
                </div>
            </div>
            <div class="card-list" id="worker-list-render"></div>
        </section>
    </div>

    <div id="action-modal" class="modal" onclick="if(event.target==this)this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="modal-title" style="margin-top:0">æ“ä½œè®°å½•</h2>
            <div id="modal-body"></div>
            <button class="ios-btn" onclick="saveAction()">æäº¤è®°å½•</button>
        </div>
    </div>

    <nav class="nav-tab">
        <div class="nav-btn active" onclick="switchTab('home', this)"><i>ğŸ </i>æ€»è§ˆ</div>
        <div class="nav-btn" onclick="switchTab('client', this)"><i>ğŸ’°</i>æ”¶å…¥</div>
        <div class="nav-btn" onclick="switchTab('vendor', this)"><i>ğŸ“‰</i>æ”¯å‡º</div>
        <div class="nav-btn" onclick="switchTab('worker', this)"><i>ğŸ‘·</i>å·¥äºº</div>
    </nav>

<script>
    const S_URL = "https://vjelnswcmypvypegqxrb.supabase.co";
    const S_KEY = "sb_publishable_BUhR8WlHyaOHnK5IjEGKtw_lcre2gFT";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let currentAction = { type: '', name: '' };

    function switchTab(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('page-' + id).classList.add('active');
        el.classList.add('active');
        refreshAllData();
    }

    // æ™ºèƒ½ Excel å¯¼å…¥
    async function handleExcelImport(input) {
        const file = input.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type:'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

            const invoices = [], vendorInvoices = [];
            json.forEach(r => {
                const isIncome = String(r['é”€æ–¹åç§°']).includes('æ’ä¸°');
                const obj = {
                    invoice_num: String(r['æ•°ç”µå‘ç¥¨å·ç '] || '').trim(),
                    amount: parseFloat(r['ä»·ç¨åˆè®¡'] || 0),
                    inv_date: String(r['å¼€ç¥¨æ—¥æœŸ'] || '')
                };
                if(isIncome) {
                    obj.client_name = String(r['è´­ä¹°æ–¹åç§°']).trim();
                    invoices.push(obj);
                } else {
                    obj.vendor_name = String(r['é”€æ–¹åç§°']).trim();
                    vendorInvoices.push(obj);
                }
            });

            if(invoices.length) await supabaseClient.from('invoices').upsert(invoices, {onConflict:'invoice_num'});
            if(vendorInvoices.length) await supabaseClient.from('vendor_invoices').upsert(vendorInvoices, {onConflict:'invoice_num'});
            
            alert(`åŒæ­¥æˆåŠŸï¼è¯†åˆ«åˆ° ${invoices.length} ç¬”æ”¶å…¥ï¼Œ${vendorInvoices.length} ç¬”æ”¯å‡ºã€‚`);
            refreshAllData();
        };
        reader.readAsArrayBuffer(file);
    }

    async function refreshAllData() {
        // å…¨é‡æŠ“å–æ•°æ®
        const { data: invs } = await supabaseClient.from('invoices').select('*');
        const { data: vInvs } = await supabaseClient.from('vendor_invoices').select('*');
        const { data: pays } = await supabaseClient.from('payments').select('*');
        const { data: vPays } = await supabaseClient.from('vendor_payments').select('*');
        const { data: workers } = await supabaseClient.from('workers').select('*');
        const { data: wLogs } = await supabaseClient.from('work_logs').select('*');
        const { data: wPays } = await supabaseClient.from('worker_payments').select('*');

        // è®¡ç®—çœ‹æ¿
        let arTotal = 0, apTotal = 0, wgTotal = 0;

        // æ¸²æŸ“å®¢æˆ·
        const clientSummary = summarize(invs, pays, 'client_name');
        renderList('client-list-render', clientSummary, 'badge-green', 'å¾…æ”¶');
        Object.values(clientSummary).forEach(s => arTotal += (s.t - s.p));

        // æ¸²æŸ“ä¾›åº”å•†
        const vendorSummary = summarize(vInvs, vPays, 'vendor_name');
        renderList('vendor-list-render', vendorSummary, 'badge-red', 'åº”ä»˜');
        Object.values(vendorSummary).forEach(s => apTotal += (s.t - s.p));

        // æ¸²æŸ“å·¥äºº
        renderWorkers(workers, wLogs, wPays);

        document.getElementById('total-ar').innerText = `Â¥${arTotal.toFixed(0)}`;
        document.getElementById('total-ap').innerText = `Â¥${apTotal.toFixed(0)}`;
        document.getElementById('main-balance').innerText = `Â¥ ${(arTotal - apTotal).toLocaleString()}`;
    }

    function summarize(items, pays, key) {
        const res = {};
        (items||[]).forEach(i => {
            if(!res[i[key]]) res[i[key]] = { t:0, p:0 };
            res[i[key]].t += i.amount;
        });
        (pays||[]).forEach(p => {
            if(res[p[key]]) res[p[key]].p += p.amount;
        });
        return res;
    }

    function renderList(id, summary, badgeClass, label) {
        const container = document.getElementById(id);
        container.innerHTML = '';
        Object.keys(summary).sort((a,b)=>(summary[b].t-summary[b].p)-(summary[a].t-summary[a].p)).forEach(name => {
            const s = summary[name];
            const diff = s.t - s.p;
            container.innerHTML += `
                <div class="item-card" onclick="openActionModal('${name}', '${id}')">
                    <div class="item-info">
                        <div class="name">${name}</div>
                        <div class="sub">æ€»é‡‘é¢: Â¥${s.t.toFixed(0)} | å·²ä»˜: Â¥${s.p.toFixed(0)}</div>
                    </div>
                    <div class="item-money">
                        <div class="amt">Â¥${diff.toFixed(0)}</div>
                        <div class="status ${badgeClass}">${label}</div>
                    </div>
                </div>
            `;
        });
    }

    function renderWorkers(workers, logs, pays) {
        const container = document.getElementById('worker-list-render');
        container.innerHTML = '';
        (workers||[]).forEach(w => {
            const hours = (logs||[]).filter(l=>l.worker_name===w.name).reduce((a,b)=>a+b.hours, 0);
            const paid = (pays||[]).filter(p=>p.worker_name===w.name).reduce((a,b)=>a+b.amount, 0);
            const due = (hours * w.hourly_rate) - paid;
            container.innerHTML += `
                <div class="item-card" onclick="openWorkerLogModal('${w.name}')">
                    <div class="item-info">
                        <div class="name">${w.name}</div>
                        <div class="sub">${w.hourly_rate}å…ƒ/æ—¶ | å·²å¹²${hours}å·¥æ—¶</div>
                    </div>
                    <div class="item-money">
                        <div class="amt">Â¥${due.toFixed(0)}</div>
                        <div class="status badge-red">å¾…å‘å·¥èµ„</div>
                    </div>
                </div>
            `;
        });
    }

    // äº¤äº’é€»è¾‘
    function openActionModal(name, type) {
        currentAction = { name, type };
        document.getElementById('modal-title').innerText = name;
        document.getElementById('modal-body').innerHTML = `
            <input type="number" id="form-amt" class="ios-input" placeholder="è¾“å…¥å›æ¬¾/ä»˜æ¬¾é‡‘é¢">
            <input type="text" id="form-note" class="ios-input" placeholder="å¤‡æ³¨ (å¯é€‰)">
        `;
        document.getElementById('action-modal').style.display = 'flex';
    }

    async function saveAction() {
        const amt = parseFloat(document.getElementById('form-amt').value);
        if(!amt) return alert("è¯·è¾“å…¥é‡‘é¢");
        
        const table = currentAction.type === 'client-list-render' ? 'payments' : 'vendor_payments';
        const col = currentAction.type === 'client-list-render' ? 'client_name' : 'vendor_name';
        
        await supabaseClient.from(table).insert([{ [col]: currentAction.name, amount: amt }]);
        document.getElementById('action-modal').style.display = 'none';
        refreshAllData();
    }

    async function openWorkerModal() {
        const name = prompt("å·¥äººå§“å:");
        const rate = prompt("æ—¶è–ª:");
        if(name && rate) {
            await supabaseClient.from('workers').upsert([{ name, hourly_rate: parseFloat(rate) }]);
            refreshAllData();
        }
    }

    async function openWorkerLogModal(name) {
        const hours = prompt(`ä¸º ${name} è®°å½•å·¥æ—¶ (å°æ—¶):`);
        if(hours) {
            await supabaseClient.from('work_logs').insert([{ worker_name: name, hours: parseFloat(hours) }]);
            refreshAllData();
        }
    }

    refreshAllData();
</script>
</body>
</html>
