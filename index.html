<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ’ä¸°è´¢åŠ¡ Pro - è‡³å°Šç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --ios-blue: #007AFF; --ios-green: #34C759; --ios-red: #FF3B30;
            --ios-bg: #F2F2F7; --ios-card: rgba(255, 255, 255, 0.85);
            --text-main: #1C1C1E; --text-sub: #8E8E93;
        }

        body {
            background: var(--ios-bg); color: var(--text-main);
            font-family: -apple-system, "SF Pro Display", system-ui;
            margin: 0; padding-bottom: 100px; -webkit-font-smoothing: antialiased;
        }

        /* å…¨å±€æ¨¡ç³ŠèƒŒæ™¯è£…é¥° */
        body::before {
            content: ""; position: fixed; top: -50px; right: -50px; width: 200px; height: 200px;
            background: radial-gradient(circle, rgba(0,122,255,0.15) 0%, transparent 70%); z-index: -1;
        }

        /* é¡¶éƒ¨å¯¼èˆªä¸æ—¶é—´é€‰æ‹© */
        .header { padding: 60px 20px 20px; position: sticky; top: 0; background: rgba(242,242,247,0.8); backdrop-filter: blur(20px); z-index: 100; }
        .header h1 { font-size: 32px; margin: 0; font-weight: 800; letter-spacing: -1px; }
        
        .time-filter {
            display: flex; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 10px; margin-top: 15px; gap: 4px;
        }
        .time-btn {
            flex: 1; border: none; padding: 6px 0; border-radius: 7px; font-size: 13px; font-weight: 600;
            color: var(--text-sub); background: transparent; transition: all 0.2s;
        }
        .time-btn.active { background: white; color: var(--ios-blue); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* åŠ¨æ€å¤§çœ‹æ¿ */
        .hero-card {
            background: linear-gradient(160deg, #1c1c1e 0%, #3a3a3c 100%);
            border-radius: 28px; padding: 25px; margin: 20px; color: white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.12); position: relative; overflow: hidden;
        }
        .hero-card::after { content: "HF"; position: absolute; right: -10px; bottom: -20px; font-size: 100px; font-weight: 900; opacity: 0.05; }
        .hero-val { font-size: 40px; font-weight: 800; margin: 10px 0; font-family: 'SF Mono', monospace; letter-spacing: -1px; }

        /* å†…å®¹å¸ƒå±€ */
        .container { padding: 0 20px; max-width: 600px; margin: 0 auto; }
        .section-title { font-size: 20px; font-weight: 700; margin: 25px 0 15px 5px; display: flex; justify-content: space-between; align-items: center; }
        
        /* è‹¹æœé£æ ¼åˆ—è¡¨å¡ç‰‡ */
        .ios-card {
            background: var(--ios-card); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 18px; margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.5); display: flex; justify-content: space-between; align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .ios-card:active { transform: scale(0.97); background: rgba(255,255,255,0.6); }
        .ios-card .name { font-size: 17px; font-weight: 600; }
        .ios-card .sub { font-size: 12px; color: var(--text-sub); margin-top: 3px; }
        .ios-card .amt { font-family: 'SF Mono'; font-weight: 700; font-size: 17px; }

        /* åº•éƒ¨å¯¼èˆª */
        .nav-tab {
            position: fixed; bottom: 0; width: 100%; height: 88px; background: rgba(255,255,255,0.8);
            backdrop-filter: blur(25px); border-top: 0.5px solid rgba(0,0,0,0.08);
            display: flex; padding-bottom: 20px; z-index: 1000;
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; font-weight: 600; }
        .nav-item.active { color: var(--ios-blue); }
        .nav-item i { font-size: 24px; margin-bottom: 4px; }

        /* æµ®åŠ¨é¢æ¿ */
        .sheet { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: none; }
        .sheet-content {
            position: absolute; bottom: 0; width: 100%; height: 88%; background: var(--ios-bg);
            border-radius: 30px 30px 0 0; padding: 30px 20px; box-sizing: border-box; overflow-y: auto;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1); animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* æŒ‰é’® */
        .btn-primary { background: var(--ios-blue); color: white; border: none; padding: 14px 24px; border-radius: 16px; font-weight: 700; width: 100%; font-size: 16px; }
        .btn-ghost { background: rgba(0,0,0,0.05); color: var(--text-main); border: none; padding: 8px 15px; border-radius: 10px; font-weight: 600; font-size: 13px; }
        .btn-danger { color: var(--ios-red); background: rgba(255,59,48,0.1); border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; }

        .tag { padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; margin-right: 6px; }
        .tag-blue { background: rgba(0,122,255,0.1); color: var(--ios-blue); }
        .tag-green { background: rgba(52,199,89,0.1); color: var(--ios-green); }

        .page { display: none; } .page.active { display: block; }
    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>æ’ä¸° Pro</h1>
            <button class="btn-ghost" onclick="manualAdd()">+ å¿«é€Ÿå½•å…¥</button>
        </div>
        <div class="time-filter">
            <button class="time-btn active" onclick="setTime('all', this)">å…¨éƒ¨</button>
            <button class="time-btn" onclick="setTime('month', this)">æœ¬æœˆ</button>
            <button class="time-btn" onclick="setTime('year', this)">æœ¬å¹´</button>
        </div>
    </div>

    <section id="home" class="page active">
        <div class="hero-card">
            <div style="font-size: 13px; opacity: 0.7; font-weight: 600;">å½“å‰åŒºé—´å‡€ç»“ä½™</div>
            <div class="hero-val" id="profit-val">Â¥ 0.00</div>
            <div style="display:flex; gap:15px; margin-top:20px; font-size:12px; opacity:0.8">
                <span>æ”¶: <b id="sum-ar">0</b></span>
                <span>æ”¯: <b id="sum-ap">0</b></span>
                <span>å·¥: <b id="sum-wg">0</b></span>
            </div>
        </div>
        <div class="container">
            <div class="ios-card" style="background: linear-gradient(135deg, #fff 0%, #f0f7ff 100%);">
                <div>
                    <div class="name">åŒæ­¥æ•°æ®</div>
                    <div class="sub">å¯¼å…¥å‘ç¥¨ Excel è‡ªåŠ¨æ ¸ç®—</div>
                </div>
                <button class="btn-primary" style="width:auto;" onclick="document.getElementById('file-up').click()">ğŸ“¥ å¯¼å…¥</button>
                <input type="file" id="file-up" hidden onchange="handleExcel(this)">
            </div>
        </div>
    </section>

    <section id="income" class="page"><div class="container" id="list-income"></div></section>
    <section id="vendor" class="page"><div class="container" id="list-vendor"></div></section>
    <section id="worker" class="page"><div class="container" id="list-worker"></div></section>

    <div id="sheet" class="sheet" onclick="if(event.target===this)this.style.display='none'">
        <div class="sheet-content">
            <div id="sheet-header" style="margin-bottom:30px"></div>
            <div id="sheet-body"></div>
        </div>
    </div>

    <nav class="nav-tab">
        <div class="nav-item active" onclick="switchTab('home', this)"><i>ğŸ </i>æ€»è§ˆ</div>
        <div class="nav-item" onclick="switchTab('income', this)"><i>ğŸ’°</i>å®¢æˆ·</div>
        <div class="nav-item" onclick="switchTab('vendor', this)"><i>ğŸ“‰</i>ä¾›åº”å•†</div>
        <div class="nav-item" onclick="switchTab('worker', this)"><i>ğŸ‘·</i>å·¥äºº</div>
    </nav>
</div>

<script>
    const S_URL = "https://vjelnswcmypvypegqxrb.supabase.co";
    const S_KEY = "sb_publishable_BUhR8WlHyaOHnK5IjEGKtw_lcre2gFT";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let db = { invs:[], vInvs:[], pays:[], vPays:[], workers:[], wLogs:[], wPays:[] };
    let timeRange = 'all';

    function setTime(range, el) {
        document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('active'));
        el.classList.add('active');
        timeRange = range;
        renderAll();
    }

    function switchTab(id, el) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        loadData();
    }

    // æ ¸å¿ƒè¿‡æ»¤é€»è¾‘
    function filterByTime(list, dateField = 'inv_date') {
        if(timeRange === 'all') return list;
        const now = new Date();
        return list.filter(item => {
            const d = new Date(item[dateField] || item.created_at || item.pay_date || item.work_date);
            if(timeRange === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            if(timeRange === 'year') return d.getFullYear() === now.getFullYear();
            return true;
        });
    }

    async function loadData() {
        const fetch = async (tbl) => (await supabaseClient.from(tbl).select('*')).data || [];
        db.invs = await fetch('invoices'); db.pays = await fetch('payments');
        db.vInvs = await fetch('vendor_invoices'); db.vPays = await fetch('vendor_payments');
        db.workers = await fetch('workers'); db.wLogs = await fetch('work_logs'); db.wPays = await fetch('worker_payments');
        renderAll();
    }

    function renderAll() {
        const invs = filterByTime(db.invs);
        const pays = filterByTime(db.pays, 'pay_date');
        const vInvs = filterByTime(db.vInvs);
        const vPays = filterByTime(db.vPays, 'pay_date');
        const wLogs = filterByTime(db.wLogs, 'work_date');
        const wPays = filterByTime(db.wPays, 'pay_date');

        const ar = invs.reduce((a,b)=>a+b.amount,0) - pays.reduce((a,b)=>a+b.amount,0);
        const ap = vInvs.reduce((a,b)=>a+b.amount,0) - vPays.reduce((a,b)=>a+b.amount,0);
        let wgArrears = 0;
        db.workers.forEach(w => {
            const earned = wLogs.filter(l=>l.worker_name===w.name).reduce((a,b)=>a+b.hours,0) * w.hourly_rate;
            const paid = wPays.filter(p=>p.worker_name===w.name).reduce((a,b)=>a+b.amount,0);
            wgArrears += (earned - paid);
        });

        animateVal('profit-val', ar - ap - wgArrears);
        document.getElementById('sum-ar').innerText = `Â¥${ar.toFixed(0)}`;
        document.getElementById('sum-ap').innerText = `Â¥${ap.toFixed(0)}`;
        document.getElementById('sum-wg').innerText = `Â¥${wgArrears.toFixed(0)}`;

        renderCatList('list-income', invs, pays, 'client_name', 'invoices', 'payments');
        renderCatList('list-vendor', vInvs, vPays, 'vendor_name', 'vendor_invoices', 'vendor_payments');
        renderWorkerList(wLogs, wPays);
    }

    function animateVal(id, target) {
        const el = document.getElementById(id);
        const start = 0;
        const duration = 500;
        let startTime = null;
        function step(timestamp) {
            if(!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / duration, 1);
            const current = progress * target;
            el.innerText = `Â¥ ${current.toLocaleString(undefined, {minimumFractionDigits:2})}`;
            if(progress < 1) window.requestAnimationFrame(step);
        }
        window.requestAnimationFrame(step);
    }

    function renderCatList(targetId, items, pays, key, t1, t2) {
        const container = document.getElementById(targetId);
        container.innerHTML = `<div class="section-title">ç®¡ç†åˆ—è¡¨</div>`;
        const names = [...new Set([...db.invs, ...db.vInvs].map(x=>x[key]).filter(Boolean))];
        
        names.forEach(name => {
            const total = items.filter(i=>i[key]===name).reduce((s,i)=>s+i.amount,0);
            const paid = pays.filter(p=>p[key]===name).reduce((s,p)=>s+p.amount,0);
            if(total === 0 && paid === 0 && timeRange !== 'all') return;
            
            container.innerHTML += `
                <div class="ios-card" onclick="showSheet('${name}', '${key}', '${t1}', '${t2}')">
                    <div><div class="name">${name}</div><div class="sub">åŒºé—´æµæ°´: Â¥${total.toFixed(0)}</div></div>
                    <div class="amt" style="color:${total-paid>0?'var(--ios-red)':'var(--ios-green)'}">Â¥${(total-paid).toFixed(0)}</div>
                </div>`;
        });
    }

    async function showSheet(name, keyCol, t1, t2) {
        const sheet = document.getElementById('sheet');
        sheet.style.display = 'block';
        document.getElementById('sheet-header').innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:start">
                <div><h2 style="margin:0">${name}</h2><p class="sub">å•ä½è´¦ç›®ç®¡ç†</p></div>
                <button class="btn-danger" onclick="deleteEntity('${name}','${keyCol}','${t1}','${t2}')">å½»åº•åˆ é™¤å•ä½</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-primary" style="flex:1" onclick="quickPay('${name}','${keyCol}','${t2}')">è®°æ¬¾é¡¹</button>
                <button class="btn-primary" style="flex:1; background:#8E8E93" onclick="manualFix('${name}','${keyCol}','${t1}')">æ ¡å‡†</button>
            </div>`;
        
        const {data:d1} = await supabaseClient.from(t1).select('*').eq(keyCol, name);
        const {data:d2} = await supabaseClient.from(t2).select('*').eq(keyCol, name);
        
        let html = '<div style="margin-top:30px">';
        [...(d1||[]).map(x=>({...x,tag:'é¡¹ç›®',c:'blue'})), ...(d2||[]).map(x=>({...x,tag:'æ¬¾é¡¹',c:'green'}))]
        .sort((a,b)=>new Date(b.inv_date||b.pay_date||b.created_at) - new Date(a.inv_date||a.pay_date||a.created_at))
        .forEach(item => {
            html += `
                <div style="display:flex; justify-content:space-between; padding:15px 0; border-bottom:1px solid rgba(0,0,0,0.05)">
                    <div><span class="tag tag-${item.c}">${item.tag}</span><span style="font-size:13px">${item.inv_date||item.pay_date||''}</span>
                    <div class="sub" style="font-size:11px">${item.invoice_num||item.remark||''}</div></div>
                    <div style="text-align:right"><div class="amt">Â¥${item.amount.toFixed(2)}</div>
                    <button style="border:none; background:none; color:var(--ios-red); font-size:11px" onclick="deleteRec('${item.id}','${item.tag==='é¡¹ç›®'?t1:t2}')">åˆ é™¤</button></div>
                </div>`;
        });
        document.getElementById('sheet-body').innerHTML = html + '</div>';
    }

    async function deleteEntity(n,k,t1,t2) {
        if(confirm("ç¡®å®šæ°¸ä¹…åˆ é™¤è¯¥å•ä½åŠå…¶æ‰€æœ‰å†å²è®°å½•ï¼Ÿ")) {
            await supabaseClient.from(t1).delete().eq(k,n);
            await supabaseClient.from(t2).delete().eq(k,n);
            sheet.style.display='none'; loadData();
        }
    }

    async function deleteRec(id, tbl) {
        if(confirm("ç¡®å®šåˆ é™¤æ­¤è®°å½•ï¼Ÿ")) {
            await supabaseClient.from(tbl).delete().eq('id',id);
            sheet.style.display='none'; loadData();
        }
    }

    function renderWorkerList(wLogs, wPays) {
        const container = document.getElementById('list-worker');
        container.innerHTML = `<div class="section-title">å·¥äººåå†Œ</div>`;
        db.workers.forEach(w => {
            const hours = wLogs.filter(l=>l.worker_name===w.name).reduce((a,b)=>a+b.hours,0);
            const paid = wPays.filter(p=>p.worker_name===w.name).reduce((a,b)=>a+b.amount,0);
            const due = (hours * w.hourly_rate) - paid;
            container.innerHTML += `
                <div class="ios-card" onclick="showSheet('${w.name}', 'worker_name', 'work_logs', 'worker_payments')">
                    <div><div class="name">${w.name}</div><div class="sub">${w.hourly_rate}å…ƒ/æ—¶ | åŒºé—´:${hours}h</div></div>
                    <div class="amt" style="color:var(--ios-red)">Â¥${due.toFixed(0)}</div>
                </div>`;
        });
    }

    // å¤ç”¨ä¹‹å‰çš„æ‰‹åŠ¨æ·»åŠ é€»è¾‘ï¼Œæ•´åˆæ›´ç¾è§‚çš„ prompt
    async function manualAdd() {
        const type = prompt("æ·»åŠ ç±»å‹: 1.å®¢æˆ· 2.ä¾›åº”å•† 3.å·¥äºº (è¾“å…¥æ•°å­—)");
        const name = prompt("åç§°:");
        if(!name) return;
        if(type === '3') {
            const r = prompt("æ—¶è–ª:");
            await supabaseClient.from('workers').upsert({name, hourly_rate: parseFloat(r)});
        } else {
            const tbl = type === '1' ? 'invoices' : 'vendor_invoices';
            const col = type === '1' ? 'client_name' : 'vendor_name';
            const amt = prompt("åˆå§‹é‡‘é¢ (æ— åˆ™å¡«0):");
            await supabaseClient.from(tbl).insert({[col]:name, amount:parseFloat(amt), invoice_num:'æ‰‹åŠ¨åˆ›å»º-'+Date.now()});
        }
        loadData();
    }

    async function handleExcel(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const upInvs = [], upVInvs = [];
            json.forEach(r => {
                const item = { invoice_num: String(r['æ•°ç”µå‘ç¥¨å·ç ']||''), amount: parseFloat(r['ä»·ç¨åˆè®¡']||0), inv_date: String(r['å¼€ç¥¨æ—¥æœŸ']||'') };
                if(String(r['é”€æ–¹åç§°']).includes('æ’ä¸°')) { item.client_name = r['è´­ä¹°æ–¹åç§°']; upInvs.push(item); }
                else { item.vendor_name = r['é”€æ–¹åç§°']; upVInvs.push(item); }
            });
            if(upInvs.length) await supabaseClient.from('invoices').upsert(upInvs, {onConflict:'invoice_num'});
            if(upVInvs.length) await supabaseClient.from('vendor_invoices').upsert(upVInvs, {onConflict:'invoice_num'});
            alert("åŒæ­¥æˆåŠŸ"); loadData();
        };
        reader.readAsArrayBuffer(file);
    }

    async function quickPay(n,c,t){ 
        const a=prompt("é‡‘é¢:"); 
        if(a) await supabaseClient.from(t).insert({[c]:n, amount:parseFloat(a), pay_date:new Date().toISOString().split('T')[0]}); 
        loadData(); document.getElementById('sheet').style.display='none'; 
    }

    async function manualFix(n,c,t){ 
        const a=prompt("æ ¡å‡†é‡‘é¢(æ­£åŠ è´Ÿå‡):"); 
        if(a) await supabaseClient.from(t).insert({[c]:n, amount:parseFloat(a), inv_date:new Date().toISOString().split('T')[0], invoice_num:'æ ¡å‡†-'+Date.now()}); 
        loadData(); document.getElementById('sheet').style.display='none'; 
    }

    window.onload = loadData;
</script>
</body>
</html>
