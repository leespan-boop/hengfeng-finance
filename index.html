<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ’ä¸°è´¢åŠ¡äº‘ 10.0 - å°Šäº«ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007aff; --bg: #f2f2f7; --card: #ffffff; --text: #1c1c1e; --green: #34c759; --red: #ff3b30; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text); }
        
        /* å¯¼èˆªæ  */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #d1d1d6; z-index: 1000; }
        .nav-item { text-align: center; font-size: 10px; color: #8e8e93; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item div { font-size: 20px; margin-bottom: 2px; }

        /* å†…å®¹åŒº */
        .page { display: none; padding: 15px; }
        .page.active { display: block; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; border-left: 4px solid var(--primary); }
        .stat-val { font-size: 18px; font-weight: bold; margin-top: 5px; }

        /* è¡¨æ ¼ä¸åˆ—è¡¨ */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 12px; color: #8e8e93; padding: 8px; }
        td { padding: 12px 8px; border-top: 1px solid #f2f2f7; font-size: 14px; }
        .money { font-family: "SF Mono", monospace; font-weight: 600; }

        /* æŒ‰é’®ä¸è¡¨å• */
        .btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; }
        .input-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d1d6; border-radius: 8px; box-sizing: border-box; }
        
        .log-box { background: #000; color: #0f0; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 11px; max-height: 100px; overflow-y: auto; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <div class="header"><h2>ğŸ“Š æ’ä¸°è´¢åŠ¡æ€»è§ˆ</h2></div>
        <div class="summary-grid">
            <div class="stat-card" style="border-color: var(--green);">
                <div style="font-size: 12px; color: #8e8e93;">å¾…æ”¶å®¢æˆ·æ¬¾</div>
                <div class="stat-val" id="sum-receivable">Â¥0.00</div>
            </div>
            <div class="stat-card" style="border-color: var(--red);">
                <div style="font-size: 12px; color: #8e8e93;">å¾…ä»˜ä¾›åº”å•†</div>
                <div class="stat-val" id="sum-payable">Â¥0.00</div>
            </div>
            <div class="stat-card" style="border-color: #ff9500;">
                <div style="font-size: 12px; color: #8e8e93;">å¾…ä»˜å·¥èµ„</div>
                <div class="stat-val" id="sum-wages">Â¥0.00</div>
            </div>
        </div>
        <div class="card">
            <h3>å¿«æ·æ“ä½œ</h3>
            <input type="file" id="importFile" style="display: none;" onchange="handleImport(this)">
            <button class="btn" onclick="document.getElementById('importFile').click()">ğŸ“¥ å¯¼å…¥ç¨åŠ¡å‘ç¥¨è¡¨</button>
            <div id="importLog" class="log-box">> å‡†å¤‡å°±ç»ª</div>
        </div>
    </div>

    <div id="page-income" class="page">
        <div class="header"><h2>ğŸ’° å®¢æˆ·æ”¶æ¬¾</h2></div>
        <div class="card">
            <table id="table-income">
                <thead><tr><th>å®¢æˆ·</th><th>åº”æ”¶</th><th>ä½™é¢</th><th>æ“ä½œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="page-vendor" class="page">
        <div class="header"><h2>ğŸ“‰ ä¾›åº”å•†æˆæœ¬</h2></div>
        <p style="color:gray; font-size:12px;">(é€»è¾‘åŒæ”¶å…¥ï¼Œå¯å¯¼å…¥ä¾›åº”å•†å‘ç¥¨è¡¨)</p>
        <div class="card">
            <table id="table-vendor">
                <thead><tr><th>ä¾›åº”å•†</th><th>åº”ä»˜</th><th>ä½™æ¬¾</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="page-worker" class="page">
        <div class="header"><h2>ğŸ‘· å·¥äººå·¥èµ„</h2></div>
        <div class="card">
            <div class="input-group">
                <input type="text" id="work-name" placeholder="å·¥äººå§“å">
                <input type="number" id="work-hours" placeholder="å·¥æ—¶" style="margin-top:5px">
                <button class="btn" style="margin-top:10px; width:100%" onclick="addWorkLog()">è®°å½•å·¥æ—¶</button>
            </div>
        </div>
        <div class="card" id="worker-list">
            </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="showPage('home')"><div>ğŸ </div>æ€»è§ˆ</div>
        <div class="nav-item" onclick="showPage('income')"><div>ğŸ’°</div>æ”¶å…¥</div>
        <div class="nav-item" onclick="showPage('vendor')"><div>ğŸ“‰</div>æˆæœ¬</div>
        <div class="nav-item" onclick="showPage('worker')"><div>ğŸ‘·</div>å·¥äºº</div>
    </div>

<script>
    const S_URL = "https://vjelnswcmypvypegqxrb.supabase.co";
    const S_KEY = "sb_publishable_BUhR8WlHyaOHnK5IjEGKtw_lcre2gFT";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    // é¡µé¢åˆ‡æ¢
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        event.currentTarget.classList.add('active');
        loadAllData();
    }

    // æ ¸å¿ƒè¯†åˆ«é€»è¾‘ï¼šå…¨é‡å‘ç¥¨å¯¼å…¥
    async function handleImport(input) {
        const file = input.files[0];
        const log = document.getElementById('importLog');
        log.innerHTML = `<div>> æ­£åœ¨è§£æ: ${file.name}</div>`;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type:'array'});
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet);

            // è¯†åˆ«æ˜¯å®¢æˆ·å‘ç¥¨è¿˜æ˜¯ä¾›åº”å•†å‘ç¥¨ (æ ¹æ®é”€æ–¹åç§°åˆ¤æ–­ï¼Œå¦‚æœé”€æ–¹æ˜¯æ’ä¸°ï¼Œå°±æ˜¯æ”¶å…¥)
            const isIncome = json.some(r => String(r['é”€æ–¹åç§°']).includes('æ’ä¸°'));
            const targetTable = isIncome ? 'invoices' : 'vendor_invoices';
            const nameKey = isIncome ? 'è´­ä¹°æ–¹åç§°' : 'é”€æ–¹åç§°';

            const rows = json.map(r => ({
                invoice_num: String(r['æ•°ç”µå‘ç¥¨å·ç '] || '').trim(),
                [isIncome ? 'client_name' : 'vendor_name']: String(r[nameKey] || '').trim(),
                amount: parseFloat(r['ä»·ç¨åˆè®¡'] || 0),
                inv_date: String(r['å¼€ç¥¨æ—¥æœŸ'] || '')
            })).filter(r => r.invoice_num && r.amount);

            log.innerHTML += `<div>> åŒ¹é…åˆ° ${rows.length} æ¡${isIncome?'æ”¶å…¥':'æˆæœ¬'}æ•°æ®ï¼Œä¸Šä¼ ä¸­...</div>`;
            
            const { error } = await supabaseClient.from(targetTable).upsert(rows, {onConflict: 'invoice_num'});
            if(error) log.innerHTML += `<div style="color:red">> é”™è¯¯: ${error.message}</div>`;
            else {
                log.innerHTML += `<div style="color:lime">> âœ… åŒæ­¥æˆåŠŸï¼</div>`;
                loadAllData();
            }
        };
        reader.readAsArrayBuffer(file);
    }

    async function loadAllData() {
        // 1. åŠ è½½æ”¶å…¥
        const { data: invs } = await supabaseClient.from('invoices').select('*');
        const { data: pays } = await supabaseClient.from('payments').select('*');
        renderTable('table-income', invs, pays, 'client_name', 'sum-receivable');

        // 2. åŠ è½½æˆæœ¬
        const { data: vInvs } = await supabaseClient.from('vendor_invoices').select('*');
        const { data: vPays } = await supabaseClient.from('vendor_payments').select('*');
        renderTable('table-vendor', vInvs, vPays, 'vendor_name', 'sum-payable');
    }

    function renderTable(tableId, items, pays, nameKey, sumId) {
        const summary = {};
        (items||[]).forEach(i => {
            const n = i[nameKey];
            if(!summary[n]) summary[n] = { t:0, p:0 };
            summary[n].t += i.amount;
        });
        (pays||[]).forEach(p => {
            if(summary[p[nameKey]]) summary[p[nameKey]].p += p.amount;
        });

        let totalDebt = 0;
        const tbody = document.querySelector(`#${tableId} tbody`);
        tbody.innerHTML = '';
        Object.keys(summary).forEach(name => {
            const s = summary[name];
            const debt = s.t - s.p;
            totalDebt += debt;
            tbody.innerHTML += `<tr>
                <td><b>${name}</b></td>
                <td>Â¥${s.t.toFixed(0)}</td>
                <td class="money ${debt>0?'red':''}">Â¥${debt.toFixed(0)}</td>
                <td><button onclick="quickPay('${name}', '${tableId}')">æ”¶/ä»˜</button></td>
            </tr>`;
        });
        document.getElementById(sumId).innerText = `Â¥${totalDebt.toLocaleString()}`;
    }

    async function quickPay(name, type) {
        const amt = prompt(`è®°å½• ${name} çš„é‡‘é¢:`);
        if(!amt) return;
        const table = type === 'table-income' ? 'payments' : 'vendor_payments';
        const nameCol = type === 'table-income' ? 'client_name' : 'vendor_name';
        await supabaseClient.from(table).insert([{ [nameCol]: name, amount: parseFloat(amt) }]);
        loadAllData();
    }

    // åˆå§‹åŒ–
    loadAllData();
</script>
</body>
</html>
