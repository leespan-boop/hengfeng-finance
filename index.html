<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>恒丰财务云 Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --accent: #007AFF;
            --bg: #F5F5F7;
            --card-bg: rgba(255, 255, 255, 0.8);
            --text-main: #1D1D1F;
            --text-sub: #86868B;
            --green: #34C759;
            --red: #FF3B30;
        }

        body {
            font-family: -apple-system, "SF Pro Display", "Helvetica Neue", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 100px;
        }

        /* 高级毛玻璃导航 */
        .tab-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 84px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom);
            border-top: 0.5px solid rgba(0,0,0,0.1);
            z-index: 9999;
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-sub);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-item.active { color: var(--accent); transform: scale(1.1); }
        .tab-icon { font-size: 24px; margin-bottom: 4px; }

        /* 内容容器 */
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .header { margin-top: 40px; margin-bottom: 30px; }
        .header h1 { font-size: 34px; font-weight: 700; margin: 0; letter-spacing: -1px; }

        /* 苹果风格卡片 */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.04);
            border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); }

        /* 核心数值展示 */
        .balance-label { font-size: 13px; color: var(--text-sub); font-weight: 600; text-transform: uppercase; }
        .balance-value { font-size: 28px; font-weight: 700; margin: 5px 0; font-variant-numeric: tabular-nums; }

        /* 列表设计 */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }
        .name { font-weight: 600; font-size: 16px; }
        .sub-name { font-size: 12px; color: var(--text-sub); }
        .amount-tag { font-family: "SF Mono", monospace; font-weight: 700; }

        /* 交互按钮 */
        .action-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 14px;
            font-weight: 600;
            width: 100%;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0,122,255,0.3);
        }

        .tag-red { color: var(--red); }
        .tag-green { color: var(--green); }

        /* 隐藏区域 */
        .page { display: none; opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
        .page.active { display: block; opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

<div class="container">
    <div id="home" class="page active">
        <div class="header">
            <h1 id="greeting">早上好</h1>
            <p style="color:var(--text-sub)">恒丰五金机械厂 财务概况</p>
        </div>

        <div class="card" style="background: linear-gradient(135deg, #007AFF, #00C7FF); color: white;">
            <div class="balance-label" style="color: rgba(255,255,255,0.8)">净收支结余</div>
            <div class="balance-value" id="total-profit">¥0.00</div>
            <p style="font-size: 12px; opacity: 0.8">实时计算：应收 - 应付 - 工资</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="card">
                <div class="balance-label">待收客户</div>
                <div class="balance-value tag-green" id="sum-in" style="font-size: 20px;">¥0</div>
            </div>
            <div class="card">
                <div class="balance-label">应付成本</div>
                <div class="balance-value tag-red" id="sum-out" style="font-size: 20px;">¥0</div>
            </div>
        </div>

        <div class="card">
            <h3>快捷同步</h3>
            <p style="font-size: 13px; color: var(--text-sub);">上传税务局 Excel，系统将自动识别收入与支出</p>
            <input type="file" id="file-upload" hidden onchange="processFile(this)">
            <button class="action-btn" onclick="document.getElementById('file-upload').click()">同步云端账簿</button>
            <div id="status-log" style="font-size: 11px; margin-top: 10px; color: var(--green)"></div>
        </div>
    </div>

    <div id="clients" class="page">
        <div class="header"><h1>客户账目</h1></div>
        <div id="client-list"></div>
    </div>

    <div id="vendors" class="page">
        <div class="header"><h1>供应商成本</h1></div>
        <div id="vendor-list"></div>
    </div>

    <div id="workers" class="page">
        <div class="header"><h1>工人工资</h1></div>
        <div class="card">
            <input type="text" id="w-name" placeholder="工人姓名" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
            <input type="number" id="w-rate" placeholder="时薪 (元/小时)" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
            <button class="action-btn" onclick="addWorker()">添加/更新工人</button>
        </div>
        <div id="worker-display-list"></div>
    </div>
</div>

<div class="tab-bar">
    <div class="tab-item active" onclick="switchTab('home')"><span class="tab-icon">􀎟</span>总览</div>
    <div class="tab-item" onclick="switchTab('clients')"><span class="tab-icon">􀍿</span>客户</div>
    <div class="tab-item" onclick="switchTab('vendors')"><span class="tab-icon">􀙦</span>供应商</div>
    <div class="tab-item" onclick="switchTab('workers')"><span class="tab-icon">􀉯</span>工人</div>
</div>

<script>
    const S_URL = "https://vjelnswcmypvypegqxrb.supabase.co";
    const S_KEY = "sb_publishable_BUhR8WlHyaOHnK5IjEGKtw_lcre2gFT";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    // 页面切换动画
    function switchTab(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        refreshData();
    }

    // 智能识别 Excel
    async function processFile(input) {
        const file = input.files[0];
        const status = document.getElementById('status-log');
        status.innerText = "⏳ 正在分析数据...";

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

            const myCompany = "恒丰五金机械厂"; 
            const invoices = [];
            const vendorInvoices = [];

            json.forEach(row => {
                const isMySale = String(row['销方名称']).includes('恒丰');
                const item = {
                    invoice_num: String(row['数电发票号码'] || ''),
                    amount: parseFloat(row['价税合计'] || 0),
                    inv_date: String(row['开票日期'] || '')
                };

                if (isMySale) {
                    item.client_name = row['购买方名称'];
                    invoices.push(item);
                } else {
                    item.vendor_name = row['销方名称'];
                    vendorInvoices.push(item);
                }
            });

            if(invoices.length > 0) await supabaseClient.from('invoices').upsert(invoices, {onConflict:'invoice_num'});
            if(vendorInvoices.length > 0) await supabaseClient.from('vendor_invoices').upsert(vendorInvoices, {onConflict:'invoice_num'});

            status.innerText = `✅ 同步完成: ${invoices.length}笔收入, ${vendorInvoices.length}笔成本`;
            refreshData();
        };
        reader.readAsArrayBuffer(file);
    }

    async function refreshData() {
        // 获取所有数据进行汇总计算
        const { data: invs } = await supabaseClient.from('invoices').select('*');
        const { data: pays } = await supabaseClient.from('payments').select('*');
        const { data: vInvs } = await supabaseClient.from('vendor_invoices').select('*');
        const { data: vPays } = await supabaseClient.from('vendor_payments').select('*');

        // 计算逻辑与渲染 (此处简化显示，确保逻辑连通)
        let totalIn = 0, totalOut = 0;
        invs.forEach(i => totalIn += i.amount);
        vInvs.forEach(i => totalOut += i.amount);

        document.getElementById('sum-in').innerText = `¥${totalIn.toFixed(0)}`;
        document.getElementById('sum-out').innerText = `¥${totalOut.toFixed(0)}`;
        document.getElementById('total-profit').innerText = `¥${(totalIn - totalOut).toLocaleString()}`;
        
        renderList('client-list', invs, pays, 'client_name');
        renderList('vendor-list', vInvs, vPays, 'vendor_name');
    }

    function renderList(targetId, items, pays, nameKey) {
        const div = document.getElementById(targetId);
        div.innerHTML = '';
        const map = {};
        items.forEach(i => {
            map[i[nameKey]] = (map[i[nameKey]] || 0) + i.amount;
        });
        Object.keys(map).forEach(name => {
            div.innerHTML += `
                <div class="card list-item">
                    <div>
                        <div class="name">${name}</div>
                        <div class="sub-name">累计交易: ¥${map[name].toFixed(0)}</div>
                    </div>
                    <div class="amount-tag tag-red">¥${map[name].toFixed(0)}</div>
                </div>
            `;
        });
    }

    window.onload = refreshData;
</script>
</body>
</html>
