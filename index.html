<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ’ä¸°è´¢åŠ¡ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --ios-bg: #F2F2F7; --ios-card: #FFFFFF; --ios-blue: #007AFF; --ios-green: #34C759; --ios-red: #FF3B30; --ios-text: #000000; --ios-sub: #8E8E93; --ios-border: rgba(0,0,0,0.05); }
        body { background: var(--ios-bg); color: var(--ios-text); font-family: -apple-system, system-ui, sans-serif; margin: 0; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
        
        /* å¸ƒå±€ */
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* é¡¶éƒ¨çœ‹æ¿ */
        .header { padding: 40px 20px 20px; }
        .header h1 { font-size: 34px; margin: 0; letter-spacing: -1px; }
        .main-card { background: #1c1c1e; color: white; border-radius: 20px; padding: 24px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .val { font-size: 36px; font-weight: 700; margin: 10px 0; font-family: 'SF Mono', monospace; }

        /* ç»Ÿä¸€åˆ—è¡¨æ ·å¼ */
        .card { background: var(--ios-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); border: 0.5px solid var(--ios-border); }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 0.5px solid var(--ios-border); }
        .row:last-child { border: none; }
        .info { flex: 1; }
        .name { font-weight: 600; font-size: 16px; }
        .sub { font-size: 12px; color: var(--ios-sub); margin-top: 2px; }
        .money { font-family: 'SF Mono'; font-weight: 700; text-align: right; }

        /* åº•éƒ¨å¯¼èˆª */
        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 84px; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; border-top: 0.5px solid var(--ios-border); padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .tab-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--ios-sub); font-size: 10px; }
        .tab-btn.active { color: var(--ios-blue); }
        .tab-btn i { font-size: 24px; margin-bottom: 4px; }

        /* æ˜ç»†æµ®å±‚ (Drawer) */
        .drawer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: none; }
        .drawer-content { position: absolute; bottom: 0; width: 100%; height: 85%; background: var(--ios-bg); border-radius: 20px 20px 0 0; overflow-y: auto; padding: 20px; box-sizing: border-box; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* æŒ‰é’®ä¸æ ‡ç­¾ */
        .btn-ios { background: var(--ios-blue); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 600; width: 100%; margin-top: 10px; }
        .btn-del { color: var(--ios-red); border: none; background: none; font-size: 12px; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .tag-in { background: #E8F5E9; color: var(--ios-green); }
        .tag-pay { background: #E3F2FD; color: var(--ios-blue); }

        .form-group { background: white; border-radius: 12px; padding: 10px; margin-bottom: 15px; }
        input { border: none; width: 100%; padding: 10px; font-size: 16px; outline: none; }
    </style>
</head>
<body>

<div id="app">
    <section id="home" class="page active">
        <div class="header"><h1>æ’ä¸°æ§åˆ¶å°</h1><p id="cur-date"></p></div>
        <div class="container">
            <div class="main-card">
                <div style="font-size: 12px; opacity: 0.7;">å‡€æ”¶æ”¯ç›ˆä½™ (CNY)</div>
                <div class="val" id="total-profit">Â¥ 0.00</div>
                <div style="display: flex; gap: 20px; font-size: 12px; margin-top: 15px; opacity: 0.8;">
                    <span>å®¢æˆ·æ¬ æ¬¾: <b id="ar-sum">0</b></span>
                    <span>æ¬ ä¾›æ–¹: <b id="ap-sum">0</b></span>
                    <span>æ¬ å·¥èµ„: <b id="wg-sum">0</b></span>
                </div>
            </div>
            <div class="card">
                <h3>æ•°æ®åŒæ­¥</h3>
                <p class="sub">æ”¯æŒç¨åŠ¡å±€å¯¼å‡ºè¡¨ï¼Œè‡ªåŠ¨åˆ†ç±»å½•å…¥</p>
                <input type="file" id="excel-up" hidden onchange="handleExcel(this)">
                <button class="btn-ios" onclick="document.getElementById('excel-up').click()">ğŸ“¥ å¯¼å…¥æœ€æ–°å‘ç¥¨ Excel</button>
            </div>
        </div>
    </section>

    <section id="income" class="page"><div class="header"><h1>æ”¶å…¥å¯¹è´¦</h1></div><div class="container" id="list-income"></div></section>
    <section id="vendor" class="page"><div class="header"><h1>æ”¯å‡ºå¯¹è´¦</h1></div><div class="container" id="list-vendor"></div></section>

    <section id="worker" class="page">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center;">
            <h1>å·¥äººå·¥èµ„</h1>
            <button class="btn-ios" style="width:auto;" onclick="showAddWorker()">+ æ·»åŠ å·¥äºº</button>
        </div>
        <div class="container" id="list-worker"></div>
    </section>

    <div id="drawer" class="drawer" onclick="if(event.target==this)this.style.display='none'">
        <div class="drawer-content">
            <div id="drawer-header" style="margin-bottom:20px;"></div>
            <div id="drawer-body"></div>
        </div>
    </div>
</div>

<nav class="tab-bar">
    <div class="tab-btn active" onclick="switchTab('home', this)"><i>ğŸ </i>æ€»è§ˆ</div>
    <div class="tab-btn" onclick="switchTab('income', this)"><i>ğŸ’°</i>å®¢æˆ·</div>
    <div class="tab-btn" onclick="switchTab('vendor', this)"><i>ğŸ“‰</i>ä¾›åº”å•†</div>
    <div class="tab-btn" onclick="switchTab('worker', this)"><i>ğŸ‘·</i>å·¥äºº</div>
</nav>

<script>
    const S_URL = "https://vjelnswcmypvypegqxrb.supabase.co";
    const S_KEY = "sb_publishable_BUhR8WlHyaOHnK5IjEGKtw_lcre2gFT";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let db = { invs:[], vInvs:[], pays:[], vPays:[], workers:[], wLogs:[], wPays:[] };

    function switchTab(id, el) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        loadData();
    }

    async function handleExcel(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const upInvs = [], upVInvs = [];
            json.forEach(r => {
                const item = { invoice_num: String(r['æ•°ç”µå‘ç¥¨å·ç ']||''), amount: parseFloat(r['ä»·ç¨åˆè®¡']||0), inv_date: String(r['å¼€ç¥¨æ—¥æœŸ']||'') };
                if(String(r['é”€æ–¹åç§°']).includes('æ’ä¸°')) { 
                    item.client_name = r['è´­ä¹°æ–¹åç§°']; upInvs.push(item); 
                } else { 
                    item.vendor_name = r['é”€æ–¹åç§°']; upVInvs.push(item); 
                }
            });
            if(upInvs.length) await supabaseClient.from('invoices').upsert(upInvs, {onConflict:'invoice_num'});
            if(upVInvs.length) await supabaseClient.from('vendor_invoices').upsert(upVInvs, {onConflict:'invoice_num'});
            alert("åŒæ­¥å®Œæˆï¼"); loadData();
        };
        reader.readAsArrayBuffer(file);
    }

    async function loadData() {
        const fetch = async (tbl) => (await supabaseClient.from(tbl).select('*')).data || [];
        db.invs = await fetch('invoices'); db.pays = await fetch('payments');
        db.vInvs = await fetch('vendor_invoices'); db.vPays = await fetch('vendor_payments');
        db.workers = await fetch('workers'); db.wLogs = await fetch('work_logs'); db.wPays = await fetch('worker_payments');
        renderAll();
    }

    function renderAll() {
        const calcSum = (items, pays, key) => {
            let total = 0;
            const res = {};
            items.forEach(i => { res[i[key]] = (res[i[key]]||0) + i.amount; total += i.amount; });
            pays.forEach(p => { total -= p.amount; });
            return total;
        };
        const ar = calcSum(db.invs, db.pays, 'client_name');
        const ap = calcSum(db.vInvs, db.vPays, 'vendor_name');
        
        let wgArrears = 0;
        db.workers.forEach(w => {
            const earned = db.wLogs.filter(l=>l.worker_name===w.name).reduce((a,b)=>a+b.hours,0) * w.hourly_rate;
            const paid = db.wPays.filter(p=>p.worker_name===w.name).reduce((a,b)=>a+b.amount,0);
            wgArrears += (earned - paid);
        });

        document.getElementById('total-profit').innerText = `Â¥ ${(ar - ap - wgArrears).toLocaleString()}`;
        document.getElementById('ar-sum').innerText = `Â¥${ar.toFixed(0)}`;
        document.getElementById('ap-sum').innerText = `Â¥${ap.toFixed(0)}`;
        document.getElementById('wg-sum').innerText = `Â¥${wgArrears.toFixed(0)}`;

        renderList('list-income', db.invs, db.pays, 'client_name', 'invoices', 'payments');
        renderList('list-vendor', db.vInvs, db.vPays, 'vendor_name', 'vendor_invoices', 'vendor_payments');
        renderWorkerList();
    }

    function renderList(target, items, pays, key, tblInv, tblPay) {
        const map = {};
        items.forEach(i => { if(!map[i[key]]) map[i[key]] = {t:0, p:0}; map[i[key]].t += i.amount; });
        pays.forEach(p => { if(map[p[key]]) map[p[key]].p += p.amount; });
        
        const container = document.getElementById(target);
        container.innerHTML = '';
        Object.keys(map).sort((a,b)=>(map[b].t-map[b].p)-(map[a].t-map[a].p)).forEach(name => {
            const m = map[name];
            container.innerHTML += `
                <div class="card" onclick="showDetail('${name}', '${key}', '${tblInv}', '${tblPay}')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="info"><div class="name">${name}</div><div class="sub">å·²ç»“: Â¥${m.p.toFixed(0)} / æ€»é¢: Â¥${m.t.toFixed(0)}</div></div>
                        <div class="money" style="color:${m.t-m.p>0?'var(--ios-red)':'var(--ios-green)'}">Â¥${(m.t-m.p).toFixed(0)}</div>
                    </div>
                </div>`;
        });
    }

    async function showDetail(name, keyCol, tblInv, tblPay) {
        const drawer = document.getElementById('drawer');
        const head = document.getElementById('drawer-header');
        const body = document.getElementById('drawer-body');
        drawer.style.display = 'block';
        
        head.innerHTML = `<h2>${name}</h2><div style="display:flex;gap:10px;">
            <button class="btn-ios" onclick="quickPay('${name}','${keyCol}','${tblPay}')">è®°ä¸€ç¬”å›æ¬¾/æ”¯å‡º</button>
            <button class="btn-ios" style="background:#8e8e93" onclick="manualFix('${name}','${keyCol}','${tblInv}')">æ‰‹åŠ¨æ ¡å‡†é‡‘é¢</button>
        </div>`;

        const {data:invs} = await supabaseClient.from(tblInv).select('*').eq(keyCol, name);
        const {data:pays} = await supabaseClient.from(tblPay).select('*').eq(keyCol, name);

        let html = '<h3>å¾€æ¥æ˜ç»†</h3>';
        [...(invs||[]).map(x=>({...x,type:'å¼€ç¥¨'})), ...(pays||[]).map(x=>({...x,type:'æ¬¾é¡¹'}))]
        .sort((a,b)=>new Date(b.created_at || b.inv_date)-new Date(a.created_at || a.inv_date))
        .forEach(item => {
            html += `<div class="row">
                <div class="info">
                    <span class="tag ${item.type==='å¼€ç¥¨'?'tag-in':'tag-pay'}">${item.type}</span>
                    <span class="sub">${item.inv_date || item.pay_date || ''}</span>
                    <div style="font-size:11px; color:#aaa">${item.invoice_num || item.remark || ''}</div>
                </div>
                <div class="money">Â¥${item.amount.toFixed(2)} 
                    <button class="btn-del" onclick="deleteRec('${tblInv}','${tblPay}','${item.id}','${item.type}')">åˆ é™¤</button>
                </div>
            </div>`;
        });
        body.innerHTML = html;
    }

    // è¿™é‡Œå®ç°åˆ é™¤é€»è¾‘
    async function deleteRec(t1, t2, id, type) {
        if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;
        const target = type === 'å¼€ç¥¨' ? t1 : t2;
        await supabaseClient.from(target).delete().eq('id', id);
        alert("å·²åˆ é™¤"); document.getElementById('drawer').style.display='none'; loadData();
    }

    async function quickPay(name, col, tbl) {
        const amt = prompt("è¾“å…¥æ¬¾é¡¹é‡‘é¢:");
        if(!amt) return;
        await supabaseClient.from(tbl).insert({ [col]:name, amount: parseFloat(amt), pay_date: new Date().toISOString().split('T')[0] });
        loadData(); document.getElementById('drawer').style.display='none';
    }

    async function manualFix(name, col, tbl) {
        const amt = prompt("æ‰‹åŠ¨æ ¡å‡†ï¼šè¾“å…¥è¦å¢åŠ (æ­£)æˆ–å‡å°‘(è´Ÿ)çš„é‡‘é¢:");
        if(!amt) return;
        await supabaseClient.from(tbl).insert({ [col]:name, amount: parseFloat(amt), invoice_num: 'æ‰‹åŠ¨æ ¡å‡†-' + Date.now() });
        loadData(); document.getElementById('drawer').style.display='none';
    }

    // å·¥äººåˆ—è¡¨åŠæ“ä½œ
    function renderWorkerList() {
        const container = document.getElementById('list-worker');
        container.innerHTML = '';
        db.workers.forEach(w => {
            const hours = db.wLogs.filter(l=>l.worker_name===w.name).reduce((a,b)=>a+b.hours,0);
            const paid = db.wPays.filter(p=>p.worker_name===w.name).reduce((a,b)=>a+b.amount,0);
            const due = (hours * w.hourly_rate) - paid;
            container.innerHTML += `<div class="card" onclick="showWorkerDetail('${w.name}', ${w.hourly_rate})">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="info"><div class="name">${w.name}</div><div class="sub">${w.hourly_rate}å…ƒ/æ—¶ | å·²ä»˜:Â¥${paid.toFixed(0)}</div></div>
                    <div class="money" style="color:var(--ios-red)">Â¥${due.toFixed(0)}</div>
                </div>
            </div>`;
        });
    }

    async function showWorkerDetail(name, rate) {
        const drawer = document.getElementById('drawer');
        drawer.style.display = 'block';
        document.getElementById('drawer-header').innerHTML = `<h2>${name}</h2>
            <div style="display:flex; gap:10px;">
                <button class="btn-ios" onclick="addWLog('${name}')">è®°å·¥æ—¶</button>
                <button class="btn-ios" style="background:var(--ios-green)" onclick="addWPay('${name}')">å‘å·¥èµ„</button>
                <button class="btn-ios" style="background:var(--ios-red); width:auto;" onclick="delWorker('${name}')">åˆ é™¤å·¥äºº</button>
            </div>`;
        
        const logs = db.wLogs.filter(l=>l.worker_name===name);
        const pays = db.wPays.filter(p=>p.worker_name===name);
        let html = '<h3>å·¥è´¹æ˜ç»†</h3>';
        [...logs.map(l=>({...l,type:'å·¥æ—¶'})), ...pays.map(p=>({...p,type:'å‘æ”¾'}))].forEach(item => {
            html += `<div class="row">
                <div class="info"><span class="tag">${item.type}</span><div class="sub">${item.hours ? item.hours+'å°æ—¶' : 'é‡‘é¢:Â¥'+item.amount}</div></div>
                <button class="btn-del" onclick="deleteWorkerData('${item.id}', '${item.type}')">åˆ é™¤</button>
            </div>`;
        });
        document.getElementById('drawer-body').innerHTML = html;
    }

    async function delWorker(name) {
        if(confirm("ç¡®å®šå½»åº•åˆ é™¤å·¥äºº "+name+" å—ï¼Ÿè¿™ä¼šæ¸…é™¤å…¶æ‰€æœ‰è®°å½•ï¼")) {
            await supabaseClient.from('workers').delete().eq('name', name);
            loadData(); document.getElementById('drawer').style.display='none';
        }
    }

    async function addWLog(n) { 
        const h = prompt("è¾“å…¥å·¥æ—¶(å°æ—¶):"); 
        if(h) { await supabaseClient.from('work_logs').insert({worker_name:n, hours:parseFloat(h)}); loadData(); document.getElementById('drawer').style.display='none'; }
    }
    async function addWPay(n) { 
        const a = prompt("è¾“å…¥å‘æ”¾é‡‘é¢:"); 
        if(a) { await supabaseClient.from('worker_payments').insert({worker_name:n, amount:parseFloat(a)}); loadData(); document.getElementById('drawer').style.display='none'; }
    }

    async function showAddWorker() {
        const n = prompt("å·¥äººå§“å:"); const r = prompt("æ—¶è–ª:");
        if(n && r) { await supabaseClient.from('workers').upsert({name:n, hourly_rate:parseFloat(r)}); loadData(); }
    }

    window.onload = loadData;
</script>
</body>
</html>
