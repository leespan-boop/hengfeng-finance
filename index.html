<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ’ä¸°è´¢åŠ¡ Pro - ä¼ä¸šçº§çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { 
            --ios-blue: #007AFF; --ios-green: #34C759; --ios-red: #FF3B30; --ios-orange: #FF9500;
            --bg: #F2F2F7; --card: #FFFFFF; --text-p: #1C1C1E; --text-s: #8E8E93;
        }
        body { background: var(--bg); color: var(--text-p); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; margin: 0; -webkit-font-smoothing: antialiased; padding-bottom: 100px; }

        /* é¡¶éƒ¨æ€»çœ‹æ¿ */
        .main-header { padding: 40px 20px 25px; background: #000; color: #fff; border-bottom-right-radius: 30px; border-bottom-left-radius: 30px; margin-bottom: 20px; }
        .net-value { font-size: 38px; font-weight: 800; letter-spacing: -1px; margin: 10px 0; font-family: 'SF Mono', monospace; }
        
        /* é¡µé¢çº§å±€éƒ¨çœ‹æ¿ */
        .sub-stat-bar { background: var(--card); margin: -10px 20px 20px; padding: 20px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); display: flex; justify-content: space-between; position: sticky; top: 10px; z-index: 100; }
        .stat-item { text-align: center; flex: 1; }
        .stat-label { font-size: 11px; color: var(--text-s); margin-bottom: 5px; display: block; }
        .stat-val { font-size: 15px; font-weight: 700; color: var(--text-p); }

        /* å››ä¸ªåŠŸèƒ½æ¿å— */
        .section-card { background: var(--card); border-radius: 22px; margin: 0 20px 15px; padding: 20px; border: 0.5px solid rgba(0,0,0,0.05); }
        .section-title { font-size: 17px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .grid-box { background: var(--bg); padding: 12px 8px; border-radius: 12px; }
        .grid-box b { font-size: 13px; display: block; margin-top: 4px; }

        /* åˆ—è¡¨é¡¹ */
        .ios-item { background: var(--card); padding: 18px; border-bottom: 0.5px solid #F2F2F7; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .ios-item:active { background: #F9F9F9; }
        .ios-item:last-child { border: none; }

        /* å¼¹çª—ä¸è¡¨å• */
        .sheet { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2000; display: none; backdrop-filter: blur(5px); }
        .sheet-content { position: absolute; bottom: 0; width: 100%; height: 88%; background: var(--bg); border-top-left-radius: 30px; border-top-right-radius: 30px; padding: 25px; box-sizing: border-box; overflow-y: auto; }
        .btn { border: none; border-radius: 14px; padding: 15px; font-weight: 700; width: 100%; margin-bottom: 12px; font-size: 16px; cursor: pointer; }
        .btn-p { background: var(--ios-blue); color: #fff; }
        .btn-s { background: #fff; color: var(--text-p); border: 0.5px solid #DDD; }

        /* å¯¼èˆª */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 85px; background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); display: flex; border-top: 0.5px solid #DDD; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; font-weight: 600; text-decoration: none; }
        .nav-link.active { color: var(--ios-blue); }
        .nav-link i { font-size: 24px; margin-bottom: 4px; }

        .page { display: none; } .page.active { display: block; }
        #login-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 40px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div style="width: 100%; max-width: 320px; text-align: center;">
        <h1 style="font-size: 28px; font-weight: 800; margin-bottom: 30px;">æ’ä¸°è´¢åŠ¡äº‘ Pro</h1>
        <input type="email" id="email" placeholder="é‚®ç®±è´¦å·" style="width:100%; padding:16px; margin-bottom:12px; border:1.5px solid #EEE; border-radius:14px; box-sizing:border-box; outline:none;">
        <input type="password" id="pw" placeholder="è®¿é—®å¯†ç " style="width:100%; padding:16px; margin-bottom:25px; border:1.5px solid #EEE; border-radius:14px; box-sizing:border-box; outline:none;">
        <button onclick="handleLogin()" class="btn btn-p">è¿›å…¥è´¢åŠ¡å¤§å±</button>
        <p id="msg" style="color:var(--ios-red); font-size:12px; margin-top:15px;"></p>
    </div>
</div>

<div id="app" style="display:none;">
    <section id="home" class="page active">
        <header class="main-header">
            <div style="display:flex; justify-content:space-between; opacity:0.6; font-size:12px; font-weight:600;"><span>æ’ä¸°è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ</span><span onclick="location.reload()">åˆ·æ–°æ•°æ®</span></div>
            <div class="net-value" id="h-net">Â¥ 0.00</div>
            <div style="font-size:12px; color:rgba(255,255,255,0.5);">æ€»èµ„äº§å‡€å€¼ (å‡€æ”¶å…¥)</div>
        </header>

        <div class="section-card" onclick="tab('income',document.getElementById('n-i'))">
            <div class="section-title">ğŸ’° å®¢æˆ·ä¸šåŠ¡</div>
            <div class="grid-3">
                <div class="grid-box"><span class="stat-label">æ€»åº”æ”¶</span><b id="h-i-t">Â¥0</b></div>
                <div class="grid-box"><span class="stat-label">å®æ”¶é‡‘é¢</span><b id="h-i-p" style="color:var(--ios-green)">Â¥0</b></div>
                <div class="grid-box"><span class="stat-label">å¾…æ”¶ä½™é¢</span><b id="h-i-d" style="color:var(--ios-red)">Â¥0</b></div>
            </div>
        </div>

        <div class="section-card" onclick="tab('vendor',document.getElementById('n-v'))">
            <div class="section-title">ğŸ“‰ ä¾›åº”å•†æ”¯å‡º</div>
            <div class="grid-3">
                <div class="grid-box"><span class="stat-label">æ€»åº”ä»˜</span><b id="h-v-t">Â¥0</b></div>
                <div class="grid-box"><span class="stat-label">å®ä»˜é‡‘é¢</span><b id="h-v-p" style="color:var(--ios-green)">Â¥0</b></div>
                <div class="grid-box"><span class="stat-label">å¾…ä»˜ä½™é¢</span><b id="h-v-d" style="color:var(--ios-red)">Â¥0</b></div>
            </div>
        </div>

        <div class="section-card" onclick="tab('worker',document.getElementById('n-w'))">
            <div class="section-title">ğŸ‘· å·¥äººå·¥èµ„</div>
            <div class="grid-3">
                <div class="grid-box"><span class="stat-label">æ€»å·¥èµ„</span><b id="h-w-t">Â¥0</b></div>
                <div class="grid-box"><span class="stat-label">å®å‘å·¥èµ„</span><b id="h-w-p" style="color:var(--ios-green)">Â¥0</b></div>
                <div class="grid-box"><span class="stat-label">å¾…å‘å·¥èµ„</span><b id="h-w-d" style="color:var(--ios-red)">Â¥0</b></div>
            </div>
        </div>
        
        <div style="padding: 0 20px;">
            <button class="btn btn-s" onclick="document.getElementById('xl-up').click()">å¯¼å…¥æ•°ç”µå‘ç¥¨ (Excel)</button>
            <input type="file" id="xl-up" hidden onchange="handleExcel(this)">
        </div>
    </section>

    <section id="income" class="page">
        <div class="sub-stat-bar">
            <div class="stat-item"><span class="stat-label">æ€»åº”æ”¶</span><div class="stat-val" id="si-t">0</div></div>
            <div class="stat-item"><span class="stat-label">å®æ”¶</span><div class="stat-val" id="si-p">0</div></div>
            <div class="stat-item"><span class="stat-label">å¾…æ”¶</span><div class="stat-val" id="si-d" style="color:var(--ios-red)">0</div></div>
        </div>
        <div id="list-income" style="margin: 0 20px; border-radius: 20px; overflow: hidden; background: #fff;"></div>
    </section>

    <section id="vendor" class="page">
        <div class="sub-stat-bar">
            <div class="stat-item"><span class="stat-label">æ€»åº”ä»˜</span><div class="stat-val" id="sv-t">0</div></div>
            <div class="stat-item"><span class="stat-label">å®ä»˜</span><div class="stat-val" id="sv-p">0</div></div>
            <div class="stat-item"><span class="stat-label">å¾…ä»˜</span><div class="stat-val" id="sv-d" style="color:var(--ios-red)">0</div></div>
        </div>
        <div id="list-vendor" style="margin: 0 20px; border-radius: 20px; overflow: hidden; background: #fff;"></div>
    </section>

    <section id="worker" class="page">
        <div class="sub-stat-bar">
            <div class="stat-item"><span class="stat-label">æ€»åº”å‘</span><div class="stat-val" id="sw-t">0</div></div>
            <div class="stat-item"><span class="stat-label">å®å‘</span><div class="stat-val" id="sw-p">0</div></div>
            <div class="stat-item"><span class="stat-label">å¾…å‘</span><div class="stat-val" id="sw-d" style="color:var(--ios-red)">0</div></div>
        </div>
        <div style="padding: 0 20px; margin-bottom: 15px;"><button class="btn btn-p" onclick="addWorker()">+ æ–°å¢å·¥äººæ¡£æ¡ˆ</button></div>
        <div id="list-worker" style="margin: 0 20px; border-radius: 20px; overflow: hidden; background: #fff;"></div>
    </section>

    <div id="sheet" class="sheet" onclick="if(event.target===this)this.style.display='none'">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div id="sheet-head"></div>
            <div id="sheet-body"></div>
        </div>
    </div>

    <nav class="nav-bar">
        <a class="nav-link active" onclick="tab('home',this)"><i>ğŸ </i>ä¸»é¡µ</a>
        <a class="nav-link" id="n-i" onclick="tab('income',this)"><i>ğŸ’°</i>å®¢æˆ·</a>
        <a class="nav-link" id="n-v" onclick="tab('vendor',this)"><i>ğŸ“‰</i>ä¾›åº”å•†</a>
        <a class="nav-link" id="n-w" onclick="tab('worker',this)"><i>ğŸ‘·</i>å·¥äºº</a>
    </nav>
</div>

<script>
    const S_URL = "https://vjelnswcmypvypegqxrb.supabase.co";
    const S_KEY = "sb_publishable_BUhR8WlHyaOHnK5IjEGKtw_lcre2gFT";
    const sb = supabase.createClient(S_URL, S_KEY);
    let db = { invs:[], vInvs:[], pays:[], vPays:[], workers:[], logs:[] };

    async function handleLogin() {
        const { error } = await sb.auth.signInWithPassword({ email:document.getElementById('email').value, password:document.getElementById('pw').value });
        if(error) document.getElementById('msg').innerText = error.message; else checkSession();
    }
    async function checkSession() {
        const { data:{session} } = await sb.auth.getSession();
        if(session) { document.getElementById('login-screen').style.display='none'; document.getElementById('app').style.display='block'; load(); }
    }
    window.onload = checkSession;

    async function load() {
        const f = async (t) => (await sb.from(t).select('*')).data || [];
        db.invs = await f('invoices'); db.pays = await f('payments');
        db.vInvs = await f('vendor_invoices'); db.vPays = await f('vendor_payments');
        db.workers = await f('workers'); db.logs = await f('wage_logs');
        renderAll();
    }

    function fmt(n) { return 'Â¥' + (n||0).toLocaleString(undefined, {minimumFractionDigits:0}); }

    function renderAll() {
        // è®¡ç®—å®¢æˆ·ç»´åº¦
        const it = db.invs.reduce((s,i)=>s+i.amount,0), ip = db.pays.reduce((s,i)=>s+i.amount,0), id = it - ip;
        // è®¡ç®—ä¾›åº”å•†ç»´åº¦
        const vt = db.vInvs.reduce((s,i)=>s+i.amount,0), vp = db.vPays.reduce((s,i)=>s+i.amount,0), vd = vt - vp;
        // è®¡ç®—å·¥äººç»´åº¦ (å®å‘ = ç±»å‹ä¸º'å‘å·¥èµ„'çš„é‡‘é¢)
        const wt = db.logs.filter(l=>['å·¥æ—¶','å¥–é‡‘','åˆ†çº¢'].includes(l.type)).reduce((s,l)=>s+l.amount,0);
        const wp = db.logs.filter(l=>l.type==='å‘å·¥èµ„').reduce((s,l)=>s+l.amount,0);
        const wd = wt - wp;

        // æ›´æ–°ä¸»é¡µçœ‹æ¿
        document.getElementById('h-net').innerText = fmt(it - vt - wt);
        document.getElementById('h-i-t').innerText = fmt(it); document.getElementById('h-i-p').innerText = fmt(ip); document.getElementById('h-i-d').innerText = fmt(id);
        document.getElementById('h-v-t').innerText = fmt(vt); document.getElementById('h-v-p').innerText = fmt(vp); document.getElementById('h-v-d').innerText = fmt(vd);
        document.getElementById('h-w-t').innerText = fmt(wt); document.getElementById('h-w-p').innerText = fmt(wp); document.getElementById('h-w-d').innerText = fmt(wd);

        // æ›´æ–°å­é¡µé¡¶éƒ¨çœ‹æ¿
        document.getElementById('si-t').innerText = fmt(it); document.getElementById('si-p').innerText = fmt(ip); document.getElementById('si-d').innerText = fmt(id);
        document.getElementById('sv-t').innerText = fmt(vt); document.getElementById('sv-p').innerText = fmt(vp); document.getElementById('sv-d').innerText = fmt(vd);
        document.getElementById('sw-t').innerText = fmt(wt); document.getElementById('sw-p').innerText = fmt(wp); document.getElementById('sw-d').innerText = fmt(wd);

        renderList('list-income', db.invs, db.pays, 'client_name', 'invoices', 'payments');
        renderList('list-vendor', db.vInvs, db.vPays, 'vendor_name', 'vendor_invoices', 'vendor_payments');
        renderWorkerList();
    }

    function renderList(elId, invs, pays, key, t1, t2) {
        const el = document.getElementById(elId); el.innerHTML = '';
        const names = [...new Set(invs.map(i=>i[key]))].filter(Boolean);
        names.forEach(n => {
            const diff = invs.filter(i=>i[key]===n).reduce((s,i)=>s+i.amount,0) - pays.filter(p=>p[key]===n).reduce((s,p)=>s+p.amount,0);
            el.innerHTML += `<div class="ios-item" onclick="showDetail('${n}','${key}','${t1}','${t2}')">
                <b>${n}</b><span style="font-family:'SF Mono'; font-weight:700; color:${diff>0?'var(--ios-red)':'var(--ios-green)'}">${fmt(diff)}</span>
            </div>`;
        });
    }

    function renderWorkerList() {
        const el = document.getElementById('list-worker'); el.innerHTML = '';
        db.workers.forEach(w => {
            const earned = db.logs.filter(l=>l.worker_name===w.name && l.type!=='å‘å·¥èµ„').reduce((s,l)=>s+l.amount,0);
            const taken = db.logs.filter(l=>l.worker_name===w.name && l.type==='å‘å·¥èµ„').reduce((s,l)=>s+l.amount,0);
            const diff = earned - taken;
            el.innerHTML += `<div class="ios-item" onclick="showWorkerDetail('${w.name}',${w.hourly_rate})">
                <b>${w.name}</b><span style="font-family:'SF Mono'; font-weight:700; color:${diff>0?'var(--ios-red)':'var(--ios-green)'}">${fmt(diff)}</span>
            </div>`;
        });
    }

    async function showDetail(n, k, t1, t2) {
        document.getElementById('sheet').style.display='block';
        document.getElementById('sheet-head').innerHTML = `<h2 style="margin-bottom:20px;">${n}</h2>
            <button class="btn btn-p" onclick="qRec('${n}','${k}','${t2}')">ç™»è®°æ¬¾é¡¹ (å›æ¬¾/æ”¯ä»˜)</button>
            <button class="btn btn-s" onclick="mInv('${n}','${k}','${t1}')">è¡¥å½•å‘ç¥¨/è°ƒè´¦</button>`;
        const {data:d1} = await sb.from(t1).select('*').eq(k,n); const {data:d2} = await sb.from(t2).select('*').eq(k,n);
        const all = [...(d1||[]).map(x=>({...x,t:'å‘ç¥¨'})),...(d2||[]).map(x=>({...x,t:'æ¬¾é¡¹'}))].sort((a,b)=>new Date(b.inv_date||b.pay_date)-new Date(a.inv_date||a.pay_date));
        document.getElementById('sheet-body').innerHTML = all.map(i=>`<div class="ios-item"><div><small style="color:#999">${i.inv_date||i.pay_date}</small><br><b>${i.t}</b></div><div style="text-align:right"><b>${fmt(i.amount)}</b><br><small style="color:red" onclick="delRec('${i.id}','${i.t==='å‘ç¥¨'?t1:t2}')">åˆ é™¤</small></div></div>`).join('');
    }

    async function showWorkerDetail(n, r) {
        document.getElementById('sheet').style.display='block';
        document.getElementById('sheet-head').innerHTML = `<h2 style="margin:0">${n}</h2><p style="color:#999; font-size:12px; margin-bottom:15px;">å½“å‰æ—¶è–ª: Â¥${r}/h</p>
            <button class="btn btn-p" onclick="logW('${n}',${r},'å·¥æ—¶')">è®°ä¸Šç­å·¥æ—¶</button>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                <button class="btn btn-s" style="color:var(--ios-orange)" onclick="logW('${n}',0,'å¥–é‡‘')">å¥–é‡‘</button>
                <button class="btn btn-s" style="color:var(--ios-blue)" onclick="logW('${n}',0,'åˆ†çº¢')">åˆ†çº¢</button>
                <button class="btn btn-s" style="color:var(--ios-green)" onclick="logW('${n}',0,'å‘å·¥èµ„')">å‘å·¥èµ„</button>
            </div>`;
        const {data} = await sb.from('wage_logs').select('*').eq('worker_name', n).order('log_date',{ascending:false});
        document.getElementById('sheet-body').innerHTML = (data||[]).map(l=>`<div class="ios-item"><div><small style="color:#999">${l.log_date}</small><br><b>${l.type}</b> ${l.work_hours?l.work_hours+'h':''}</div><div style="text-align:right"><b>${fmt(l.amount)}</b><br><small style="color:red" onclick="delRec('${l.id}','wage_logs')">åˆ é™¤</small></div></div>`).join('');
    }

    async function logW(n, r, type) {
        const d = prompt("æ—¥æœŸ:", new Date().toISOString().split('T')[0]); if(!d) return;
        let amt = 0, hrs = 0;
        if(type==='å·¥æ—¶') { hrs = prompt("å‡ å°æ—¶ï¼Ÿ"); const rate = prompt("æ—¶è–ª:", r); amt = hrs*rate; }
        else { amt = prompt(type+"é‡‘é¢:"); }
        if(amt) await sb.from('wage_logs').insert({ worker_name:n, amount:parseFloat(amt), type, work_hours:hrs?parseFloat(hrs):null, log_date:d });
        load(); document.getElementById('sheet').style.display='none';
    }

    async function addWorker() {
        const n = prompt("å§“å:"); const r = prompt("æ—¶è–ª:", 20);
        if(n) await sb.from('workers').insert({ name:n, hourly_rate:r }); load();
    }

    async function qRec(n,k,t){ const d=prompt("æ—¥æœŸ:",new Date().toISOString().split('T')[0]); const a=prompt("é‡‘é¢:"); if(a) await sb.from(t).insert({[k]:n,amount:parseFloat(a),pay_date:d}); load(); document.getElementById('sheet').style.display='none'; }
    async function mInv(n,k,t){ const d=prompt("æ—¥æœŸ:",new Date().toISOString().split('T')[0]); const a=prompt("é‡‘é¢:"); if(a) await sb.from(t).insert({[k]:n,amount:parseFloat(a),inv_date:d}); load(); document.getElementById('sheet').style.display='none'; }
    async function delRec(id,t){ if(confirm("åˆ é™¤ï¼Ÿ")){ await sb.from(t).delete().eq('id',id); load(); document.getElementById('sheet').style.display='none'; }}
    function tab(id, el) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.nav-link').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); el.classList.add('active'); }
    async function handleExcel(i){ const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=async(e)=>{ const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); const upI=[],upVI=[]; json.forEach(r=>{ const item={invoice_num:String(r['æ•°ç”µå‘ç¥¨å·ç ']||''),amount:parseFloat(r['ä»·ç¨åˆè®¡']||0),inv_date:String(r['å¼€ç¥¨æ—¥æœŸ']||'')}; if(String(r['é”€æ–¹åç§°']).includes('æ’ä¸°')){item.client_name=r['è´­ä¹°æ–¹åç§°'];upI.push(item);}else{item.vendor_name=r['é”€æ–¹åç§°'];upVI.push(item);}}); await sb.from('invoices').upsert(upI,{onConflict:'invoice_num'}); await sb.from('vendor_invoices').upsert(upVI,{onConflict:'invoice_num'}); alert("å¯¼å…¥æˆåŠŸ"); load();}; r.readAsArrayBuffer(f); }
</script>
</body>
</html>
