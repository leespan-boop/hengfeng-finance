<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ’ä¸°è´¢åŠ¡ Pro - åŠ³åŠ¡å…¨èƒ½ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --ios-blue: #007AFF; --ios-green: #34C759; --ios-red: #FF3B30; --ios-orange: #FF9500; --ios-bg: #F2F2F7; --ios-card: #FFFFFF; --text-main: #1C1C1E; --text-sub: #8E8E93; }
        body { background: var(--ios-bg); color: var(--text-main); font-family: -apple-system, system-ui, sans-serif; margin: 0; padding-bottom: 110px; -webkit-font-smoothing: antialiased; }

        /* ç»Ÿä¸€å¡ç‰‡æ ·å¼ */
        .ios-card { background: var(--ios-card); border-radius: 18px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 0.5px solid rgba(0,0,0,0.05); }
        .hero-card { background: #1c1c1e; color: white; border-radius: 24px; padding: 25px; margin: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        /* å¯¼èˆªå¤´ */
        .filter-header { padding: 50px 20px 20px; position: sticky; top: 0; background: rgba(242,242,247,0.85); backdrop-filter: blur(20px); z-index: 100; border-bottom: 0.5px solid rgba(0,0,0,0.1); }
        .date-row { display: flex; gap: 8px; margin-top: 15px; }
        .date-box { flex: 1; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 10px; font-size: 11px; color: var(--ios-blue); }
        .date-box input { border: none; background: transparent; width: 100%; font-size: 13px; color: inherit; font-weight: 600; outline: none; }

        /* è¯¦æƒ…å¼¹çª— */
        .sheet { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: none; }
        .sheet-content { position: absolute; bottom: 0; width: 100%; height: 85%; background: var(--ios-bg); border-radius: 25px 25px 0 0; padding: 25px; box-sizing: border-box; overflow-y: auto; }
        
        .btn { border: none; border-radius: 12px; padding: 12px; font-weight: 600; width: 100%; margin-bottom: 8px; font-size: 15px; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        .btn-blue { background: var(--ios-blue); color: white; }
        .btn-gray { background: #E5E5EA; color: var(--text-main); }
        
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; font-weight: 800; margin-right: 6px; text-transform: uppercase; }
        .tag-wage { background: var(--ios-orange); }
        .tag-bonus { background: var(--ios-red); }
        .tag-divi { background: #5856D6; }

        /* åº•éƒ¨å¯¼èˆª */
        .nav-tab { position: fixed; bottom: 0; width: 100%; height: 84px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); display: flex; border-top: 0.5px solid rgba(0,0,0,0.1); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; font-weight: 600; }
        .nav-item.active { color: var(--ios-blue); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }

        .page { display: none; padding: 0 20px; } 
        .page.active { display: block; }
        #login-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 40px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div style="width: 100%; max-width: 300px;">
        <h1 style="text-align: center; margin-bottom: 30px;">æ’ä¸°è´¢åŠ¡ Pro</h1>
        <input type="email" id="email" placeholder="é‚®ç®±è´¦å·" style="width:100%; padding:15px; margin-bottom:10px; border:1px solid #ddd; border-radius:12px;">
        <input type="password" id="pw" placeholder="è®¿é—®å¯†ç " style="width:100%; padding:15px; margin-bottom:20px; border:1px solid #ddd; border-radius:12px;">
        <button onclick="handleLogin()" class="btn btn-blue">ç«‹å³ç™»å½•</button>
        <p id="msg" style="color:red; text-align:center; font-size:12px;"></p>
    </div>
</div>

<div id="app" style="display:none;">
    <div class="filter-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0">æ’ä¸°æ§åˆ¶å°</h2>
            <span onclick="location.reload()" style="font-size:12px; color:var(--ios-blue)">åˆ·æ–°æ•°æ®</span>
        </div>
        <div class="date-row">
            <div class="date-box">å¼€å§‹æ—¥æœŸ<input type="date" id="s-date" onchange="renderAll()"></div>
            <div class="date-box">ç»“æŸæ—¥æœŸ<input type="date" id="e-date" onchange="renderAll()"></div>
        </div>
    </div>

    <section id="home" class="page active" style="padding:0;">
        <div class="hero-card">
            <div style="font-size: 12px; opacity: 0.7;">å‡€åˆ©æ¶¦/ç»“ä½™ (æ‰£é™¤å·¥èµ„å)</div>
            <div style="font-size: 32px; font-weight: 800; margin: 10px 0; font-family:'SF Mono'" id="net-total">Â¥ 0.00</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; font-size:12px; margin-top:10px;">
                <div>æœªæ”¶è´¦æ¬¾: <b id="ar-total">0</b></div>
                <div>åŠ³åŠ¡æ€»æ”¯å‡º: <b id="wage-total" style="color:var(--ios-orange)">0</b></div>
            </div>
        </div>
        <div style="padding: 0 20px;">
            <div class="ios-card" onclick="addWorkerPrompt()" style="border: 1px dashed var(--ios-blue); color: var(--ios-blue); justify-content: center; font-weight: bold;">
                + æ–°å¢å·¥äººæ¡£æ¡ˆ
            </div>
            <div class="ios-card" onclick="document.getElementById('xl-up').click()">
                <div><b>åŒæ­¥é”€é¡¹/è¿›é¡¹ Excel</b><div style="font-size:11px; color:#8e8e93">è‡ªåŠ¨è¯†åˆ«ä¾›åº”å•†ä¸å®¢æˆ·</div></div>
                <input type="file" id="xl-up" hidden onchange="handleExcel(this)">
                <span>ğŸ“‘</span>
            </div>
        </div>
    </section>

    <section id="income" class="page"></section>
    <section id="vendor" class="page"></section>
    <section id="worker" class="page"></section>

    <div id="sheet" class="sheet" onclick="if(event.target===this)this.style.display='none'">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div id="sheet-head"></div>
            <div id="sheet-body" style="margin-top:20px;"></div>
        </div>
    </div>

    <nav class="nav-tab">
        <div class="nav-item active" onclick="tab('home',this)">ğŸ <br>æ€»è§ˆ</div>
        <div class="nav-item" onclick="tab('income',this)">ğŸ’°<br>å®¢æˆ·</div>
        <div class="nav-item" onclick="tab('vendor',this)">ğŸ“‰<br>ä¾›åº”å•†</div>
        <div class="nav-item" onclick="tab('worker',this)">ğŸ‘·<br>å·¥äººè–ªèµ„</div>
    </nav>
</div>

<script>
    const S_URL = "https://vjelnswcmypvypegqxrb.supabase.co";
    const S_KEY = "sb_publishable_BUhR8WlHyaOHnK5IjEGKtw_lcre2gFT";
    const sb = supabase.createClient(S_URL, S_KEY);

    let db = { invs:[], vInvs:[], pays:[], vPays:[], workers:[], logs:[] };

    async function handleLogin() {
        const { error } = await sb.auth.signInWithPassword({ email:document.getElementById('email').value, password:document.getElementById('pw').value });
        if(error) document.getElementById('msg').innerText = error.message; else checkSession();
    }

    async function checkSession() {
        const { data:{session} } = await sb.auth.getSession();
        if(session) { document.getElementById('login-screen').style.display='none'; document.getElementById('app').style.display='block'; load(); }
    }
    window.onload = checkSession;

    async function load() {
        const f = async (t) => (await sb.from(t).select('*')).data || [];
        db.invs = await f('invoices'); db.pays = await f('payments');
        db.vInvs = await f('vendor_invoices'); db.vPays = await f('vendor_payments');
        db.workers = await f('workers'); db.logs = await f('wage_logs');
        renderAll();
    }

    function filter(list, key) {
        const s = document.getElementById('s-date').value, e = document.getElementById('e-date').value;
        if(!s && !e) return list;
        const start = new Date(s || '1970-01-01'), end = new Date(e || '2099-12-31');
        end.setHours(23,59,59);
        return list.filter(i => { const d = new Date(i[key] || i.log_date || i.inv_date || i.pay_date); return d >= start && d <= end; });
    }

    function renderAll() {
        const fi = filter(db.invs,'inv_date'), fp = filter(db.pays,'pay_date'), fvi = filter(db.vInvs,'inv_date'), fvp = filter(db.vPays,'pay_date'), fl = filter(db.logs,'log_date');
        
        const ar = fi.reduce((s,i)=>s+i.amount,0) - fp.reduce((s,i)=>s+i.amount,0);
        const ap = fvi.reduce((s,i)=>s+i.amount,0) - fvp.reduce((s,i)=>s+i.amount,0);
        const wages = fl.reduce((s,i)=>s+i.amount,0);

        document.getElementById('net-total').innerText = `Â¥ ${(ar - ap - wages).toLocaleString(undefined,{minimumFractionDigits:2})}`;
        document.getElementById('ar-total').innerText = `Â¥${ar.toLocaleString()}`;
        document.getElementById('wage-total').innerText = `Â¥${wages.toLocaleString()}`;

        uiList('income', db.invs, db.pays, 'client_name', 'invoices', 'payments', fi, fp);
        uiList('vendor', db.vInvs, db.vPays, 'vendor_name', 'vendor_invoices', 'vendor_payments', fvi, fvp);
        uiWorkers(fl);
    }

    function uiList(id, rawI, rawP, key, t1, t2, fI, fP) {
        const el = document.getElementById(id); el.innerHTML = `<h3 style="margin:20px 0 10px">å¾€æ¥å¯¹è´¦</h3>`;
        const names = [...new Set(rawI.map(i=>i[key]))].filter(Boolean);
        names.map(n => {
            const total = fI.filter(i=>i[key]===n).reduce((s,i)=>s+i.amount,0);
            const paid = fP.filter(i=>i[key]===n).reduce((s,i)=>s+i.amount,0);
            return { n, diff: total - paid };
        }).sort((a,b)=>b.diff-a.diff).forEach(i => {
            if(i.diff === 0) return;
            el.innerHTML += `<div class="ios-card" onclick="showSheet('${i.n}','${key}','${t1}','${t2}')">
                <b>${i.n}</b><div style="font-family:'SF Mono'; font-weight:700; color:${i.diff>0?'#FF3B30':'#34C759'}">Â¥${i.diff.toLocaleString()}</div>
            </div>`;
        });
    }

    function uiWorkers(fl) {
        const el = document.getElementById('worker'); el.innerHTML = `<h3 style="margin:20px 0 10px">å·¥äººåå½•</h3>`;
        db.workers.forEach(w => {
            const sum = fl.filter(l=>l.worker_name===w.name).reduce((s,l)=>s+l.amount,0);
            el.innerHTML += `<div class="ios-card" onclick="showWorker('${w.name}',${w.hourly_rate})">
                <div><b>${w.name}</b><div style="font-size:11px; color:#8e8e93">æ ‡å‡†æ—¶è–ª: Â¥${w.hourly_rate}</div></div>
                <div style="font-family:'SF Mono'; font-weight:700; color:var(--ios-orange)">Â¥${sum.toLocaleString()}</div>
            </div>`;
        });
    }

    async function showSheet(n, k, t1, t2) {
        document.getElementById('sheet').style.display='block';
        document.getElementById('sheet-head').innerHTML = `<h2>${n}</h2>
            <button class="btn btn-blue" onclick="quickRec('${n}','${k}','${t2}')">ç™»è®°å›æ¬¾/æ”¯ä»˜</button>
            <button class="btn btn-gray" onclick="manualInv('${n}','${k}','${t1}')">è¡¥å½•å‘ç¥¨/è°ƒè´¦</button>`;
        const {data:d1} = await sb.from(t1).select('*').eq(k,n);
        const {data:d2} = await sb.from(t2).select('*').eq(k,n);
        const all = [...(d1||[]).map(x=>({...x,t:'å‘ç¥¨',c:'tag-wage'})),...(d2||[]).map(x=>({...x,t:'æ¬¾é¡¹',c:'tag-pay'}))].sort((a,b)=>new Date(b.inv_date||b.pay_date)-new Date(a.inv_date||a.pay_date));
        document.getElementById('sheet-body').innerHTML = all.map(i=>`
            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:0.5px solid #eee">
                <div><span class="tag" style="background:#007AFF">${i.t}</span><small>${i.inv_date||i.pay_date}</small><div style="font-size:10px;color:#999">${i.invoice_num||''}</div></div>
                <div style="text-align:right"><b>Â¥${i.amount.toLocaleString()}</b><br><small style="color:red" onclick="delRec('${i.id}','${i.t==='å‘ç¥¨'?t1:t2}')">åˆ é™¤</small></div>
            </div>`).join('');
    }

    async function showWorker(n, r) {
        document.getElementById('sheet').style.display='block';
        document.getElementById('sheet-head').innerHTML = `<h2>${n} <small style="font-size:12px; color:#999">(Â¥${r}/h)</small></h2>
            <button class="btn btn-blue" onclick="logLabor('${n}',${r},'å·¥æ—¶')">ç™»è®°ä¸Šç­å·¥æ—¶</button>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-gray" style="background:#FFEDEB; color:#FF3B30" onclick="logLabor('${n}',0,'å¥–é‡‘')">å‘å¥–é‡‘</button>
                <button class="btn btn-gray" style="background:#F2F2F7" onclick="logLabor('${n}',0,'åˆ†çº¢')">å‘åˆ†çº¢</button>
            </div>`;
        const {data} = await sb.from('wage_logs').select('*').eq('worker_name', n).order('log_date',{ascending:false});
        document.getElementById('sheet-body').innerHTML = (data||[]).map(l=>`
            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:0.5px solid #eee">
                <div><span class="tag ${l.type==='å·¥æ—¶'?'tag-wage':(l.type==='å¥–é‡‘'?'tag-bonus':'tag-divi')}">${l.type}</span><small>${l.log_date}</small>
                <div style="font-size:10px; color:#999">${l.work_hours?l.work_hours+'å°æ—¶':''}</div></div>
                <div style="text-align:right"><b>Â¥${l.amount.toLocaleString()}</b><br><small style="color:red" onclick="delRec('${l.id}','wage_logs')">åˆ é™¤</small></div>
            </div>`).join('');
    }

    async function logLabor(n, r, type) {
        const d = prompt("æ—¥æœŸ (YYYY-MM-DD):", new Date().toISOString().split('T')[0]); if(!d) return;
        let amt = 0, hrs = 0;
        if(type==='å·¥æ—¶') { hrs = prompt("å¹²äº†å¤šå°‘å°æ—¶ï¼Ÿ"); amt = parseFloat(hrs)*r; }
        else { amt = prompt(type+"é‡‘é¢æ˜¯å¤šå°‘ï¼Ÿ"); }
        if(!amt) return;
        await sb.from('wage_logs').insert({ worker_name:n, amount:parseFloat(amt), type, work_hours:parseFloat(hrs), log_date:d });
        load(); document.getElementById('sheet').style.display='none';
    }

    async function addWorkerPrompt() {
        const n = prompt("å·¥äººå§“å:"); if(!n) return;
        const r = prompt("æ—¶è–ª (å…ƒ/å°æ—¶):", "20");
        await sb.from('workers').insert({ name:n, hourly_rate:parseFloat(r) });
        load();
    }

    async function quickRec(n,k,t){ const d=prompt("æ—¥æœŸ:",new Date().toISOString().split('T')[0]); const a=prompt("é‡‘é¢:"); if(a) await sb.from(t).insert({[k]:n,amount:parseFloat(a),pay_date:d}); load(); document.getElementById('sheet').style.display='none'; }
    async function manualInv(n,k,t){ const d=prompt("æ—¥æœŸ:",new Date().toISOString().split('T')[0]); const a=prompt("é‡‘é¢:"); const num=prompt("å‘ç¥¨å·:"); if(a) await sb.from(t).insert({[k]:n,amount:parseFloat(a),inv_date:d,invoice_num:num}); load(); document.getElementById('sheet').style.display='none'; }
    async function delRec(id,t){ if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")){ await sb.from(t).delete().eq('id',id); load(); document.getElementById('sheet').style.display='none'; }}

    function tab(id, el) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active'); el.classList.add('active');
    }

    async function handleExcel(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const upI = [], upVI = [];
            json.forEach(r => {
                const item = { invoice_num: String(r['æ•°ç”µå‘ç¥¨å·ç ']||''), amount: parseFloat(r['ä»·ç¨åˆè®¡']||0), inv_date: String(r['å¼€ç¥¨æ—¥æœŸ']||'') };
                if(String(r['é”€æ–¹åç§°']).includes('æ’ä¸°')) { item.client_name = r['è´­ä¹°æ–¹åç§°']; upI.push(item); }
                else { item.vendor_name = r['é”€æ–¹åç§°']; upVI.push(item); }
            });
            await sb.from('invoices').upsert(upI, {onConflict:'invoice_num'});
            await sb.from('vendor_invoices').upsert(upVI, {onConflict:'invoice_num'});
            alert("åŒæ­¥æˆåŠŸ"); load();
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
