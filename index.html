<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ä¸°è´¢åŠ¡ - äº‘ç«¯åŒæ­¥æ——èˆ°ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --accent: #007aff; --bg: #f5f5f7; --card: #ffffff; --text-main: #1d1d1f; --text-sec: #86868b; --success: #34c759; --danger: #ff3b30; }
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .nav { height: 60px; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 0.5px solid #ddd; z-index: 100; }
        .view { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }
        .card { background: #fff; padding: 20px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .apple-btn { background: var(--accent); color: #fff; border: none; padding: 10px 16px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .apple-btn:active { opacity: 0.7; }
        .apple-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-top: 8px; font-size: 16px; -webkit-appearance: none; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 12px; color: var(--text-sec); border-bottom: 1px solid #eee; padding: 12px; }
        td { padding: 12px; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        @media (max-width: 768px) { .view { flex-direction: column; overflow-y: auto; } .stat-grid { grid-template-columns: 1fr; } .view { padding: 10px; } }
    </style>
</head>
<body>

<div class="nav">
    <div style="font-weight: 700;">æ’ä¸°è´¢åŠ¡ <span style="font-weight:400; color:var(--text-sec)">Cloud</span></div>
    <button class="apple-btn" style="background:#f2f2f7; color:#333;" onclick="document.getElementById('tax_file').click()">ğŸ“‚ å¯¼å…¥ç¨åŠ¡Excel</button>
    <input type="file" id="tax_file" hidden onchange="handleTaxImport(this)">
</div>

<div class="view">
    <div style="flex: 1.5; display: flex; flex-direction: column; overflow: hidden;">
        <div class="stat-grid">
            <div class="card"><div>æ€»å¼€ç¥¨</div><div id="v_i" style="font-size:22px; font-weight:700;">0.00</div></div>
            <div class="card"><div>å·²å›æ¬¾</div><div id="v_p" style="font-size:22px; font-weight:700; color:var(--success)">0.00</div></div>
            <div class="card"><div>å¾…å›æ”¶</div><div id="v_b" style="font-size:22px; font-weight:700; color:var(--danger)">0.00</div></div>
        </div>
        <div class="card" style="flex:1; overflow-y:auto;">
            <table><thead><tr><th>å®¢æˆ·åç§°</th><th style="text-align:right;">åº”æ”¶ä½™é¢</th></tr></thead><tbody id="c_body"></tbody></table>
        </div>
    </div>
    
    <div style="flex: 0.8; display: flex; flex-direction: column; gap: 20px;">
        <div class="card">
            <div style="font-weight:700; margin-bottom:15px;">å¿«æ·å½•å…¥å›æ¬¾</div>
            <label style="font-size:12px; color:var(--text-sec)">é€‰æ‹©å®¢æˆ·</label>
            <select id="p_cli" class="apple-input"></select>
            
            <label style="font-size:12px; color:var(--text-sec); margin-top:10px; display:block;">é‡‘é¢</label>
            <input type="number" id="p_amt" class="apple-input" placeholder="è¾“å…¥å›æ¬¾é‡‘é¢">
            
            <label style="font-size:12px; color:var(--text-sec); margin-top:10px; display:block;">æ—¥æœŸ</label>
            <input type="date" id="p_day" class="apple-input">
            
            <button class="apple-btn" style="width:100%; margin-top:20px; height:50px; font-size:16px;" id="btn_save" onclick="addPay()">ç¡®è®¤è®°è´¦</button>
        </div>
    </div>
</div>

<script>
    // è‡ªåŠ¨å¡«å…¥çš„é…ç½®ä¿¡æ¯
    const SUPABASE_URL = "https://vjelnswcmypvypegqxrb.supabase.co"; 
    const SUPABASE_KEY = "sb_publishable_BUhR8WlHyaOHnK5IjEGKtw_lcre2gFT";
    
    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let INVOICES = JSON.parse(localStorage.getItem('HF_INV')) || [];
    let CLIS = JSON.parse(localStorage.getItem('HF_CLIS')) || {};
    let PAYMENTS = [];

    // ä»äº‘ç«¯è·å–å›æ¬¾æ•°æ®
    async function fetchPayments() {
        const { data, error } = await _supabase.from('payments').select('*');
        if (!error) {
            PAYMENTS = data;
            render();
        }
    }

    // å½•å…¥å›æ¬¾å¹¶ä¸Šä¼ äº‘ç«¯
    async function addPay() {
        const btn = document.getElementById('btn_save');
        const tid = document.getElementById('p_cli').value;
        const amt = parseFloat(document.getElementById('p_amt').value);
        const day = document.getElementById('p_day').value;
        
        if (!tid || isNaN(amt) || !day) { alert('è¯·æ£€æŸ¥è¾“å…¥å†…å®¹'); return; }

        btn.disabled = true; 
        btn.innerText = 'æ­£åœ¨äº‘ç«¯åŒæ­¥...';

        const { error } = await _supabase.from('payments').insert([
            { client_name: CLIS[tid], amount: amt, pay_date: day, client_id: tid }
        ]);
        
        if (error) {
            alert('åŒæ­¥å¤±è´¥: ' + error.message);
        } else {
            document.getElementById('p_amt').value = '';
            await fetchPayments();
            alert('è®°è´¦æˆåŠŸï¼æ‰‹æœº/ç”µè„‘å·²åŒæ­¥');
        }
        btn.disabled = false; 
        btn.innerText = 'ç¡®è®¤è®°è´¦';
    }

    // å¤„ç† Excel å¯¼å…¥ (æœ¬åœ°å­˜å‚¨ï¼Œä¿æŠ¤éšç§)
    function handleTaxImport(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(firstSheet);
            
            json.forEach(row => {
                const invId = String(row['æ•°ç”µç¥¨å·ç '] || row['æ•°ç”µå‘ç¥¨å·ç '] || "");
                const buyerId = String(row['è´­æ–¹è¯†åˆ«å·'] || row['è´­ä¹°æ–¹è¯†åˆ«å·'] || "");
                const buyerName = row['è´­ä¹°æ–¹åç§°'] || row['è´­æ–¹åç§°'];
                const amount = parseFloat(row['ä»·ç¨åˆè®¡'] || 0);

                if (invId && buyerId) {
                    CLIS[buyerId] = buyerName;
                    if (!INVOICES.find(x => x.id === invId)) {
                        INVOICES.push({ id: invId, tid: buyerId, amt: amount, date: row['å¼€ç¥¨æ—¥æœŸ'] });
                    }
                }
            });
            localStorage.setItem('HF_INV', JSON.stringify(INVOICES));
            localStorage.setItem('HF_CLIS', JSON.stringify(CLIS));
            render();
            alert('å‘ç¥¨å¯¼å…¥æˆåŠŸï¼');
        };
        reader.readAsArrayBuffer(file);
    }

    // æ¸²æŸ“ç•Œé¢
    function render() {
        const tbody = document.getElementById('c_body');
        const select = document.getElementById('p_cli');
        tbody.innerHTML = '';
        select.innerHTML = '<option value="">-- è¯·é€‰æ‹©å®¢æˆ· --</option>';
        
        let clientSums = {};
        // ç®—å¼€ç¥¨æ€»é¢
        INVOICES.forEach(inv => {
            if (!clientSums[inv.tid]) clientSums[inv.tid] = { i: 0, p: 0 };
            clientSums[inv.tid].i += inv.amt;
        });
        // ç®—å›æ¬¾æ€»é¢
        PAYMENTS.forEach(pay => {
            const tid = Object.keys(CLIS).find(key => CLIS[key] === pay.client_name);
            if (tid && clientSums[tid]) {
                clientSums[tid].p += pay.amount;
            }
        });

        let totalInvoice = 0, totalPaid = 0;
        
        // å¡«å……è¡¨æ ¼å’Œä¸‹æ‹‰æ¡†
        Object.keys(clientSums).sort((a,b) => (clientSums[b].i - clientSums[b].p) - (clientSums[a].i - clientSums[a].p)).forEach(tid => {
            const balance = clientSums[tid].i - clientSums[tid].p;
            totalInvoice += clientSums[tid].i;
            totalPaid += clientSums[tid].p;

            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${CLIS[tid]}</td><td style="text-align:right; font-weight:700;">${balance.toFixed(2)}</td>`;
            tbody.appendChild(tr);

            const opt = document.createElement('option');
            opt.value = tid;
            opt.text = CLIS[tid];
            select.add(opt);
        });

        document.getElementById('v_i').innerText = totalInvoice.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('v_p').innerText = totalPaid.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('v_b').innerText = (totalInvoice - totalPaid).toLocaleString(undefined, {minimumFractionDigits: 2});
    }

    // åˆå§‹åŒ–æ—¥æœŸ
    document.getElementById('p_day').valueAsDate = new Date();
    // å¯åŠ¨å³åŒæ­¥äº‘ç«¯
    fetchPayments();
</script>
</body>
</html>
</body>
</html>
