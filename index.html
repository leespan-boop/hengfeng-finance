<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ä¸°è´¢åŠ¡ - å®¢æˆ·è¯¦æƒ…åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --accent: #007aff; --bg: #f5f5f7; --card: #ffffff; --text-main: #1d1d1f; --text-sec: #86868b; --success: #34c759; --danger: #ff3b30; }
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .nav { height: 60px; background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 0.5px solid #ddd; }
        .view { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }
        .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .stat-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .stat-item { flex:1; padding:10px; border-radius:8px; background:#f9f9fb; font-size:12px; }
        .stat-val { font-size:18px; font-weight:700; margin-top:5px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 12px; color: var(--text-sec); border-bottom: 1px solid #eee; padding: 10px; position: sticky; top: 0; background: #fff; }
        td { padding: 10px; border-bottom: 1px solid #f9f9f9; font-size: 14px; cursor: pointer; }
        tr:hover td { background: #f5faff; }
        .apple-btn { background: var(--accent); color: #fff; border: none; padding: 8px 15px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .apple-input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; margin-top: 5px; margin-bottom: 10px; }
        .active-row td { background: #e1f0ff !important; font-weight: 600; }
        @media (max-width: 768px) { .view { flex-direction: column; overflow-y: auto; } .card { flex: none; } }
    </style>
</head>
<body>

<div class="nav">
    <div style="font-weight: 700; font-size:18px;">æ’ä¸°è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ</div>
    <button class="apple-btn" style="background:#f2f2f7; color:#333;" onclick="document.getElementById('tax_file').click()">ğŸ“‚ å¯¼å…¥å‘ç¥¨Excel</button>
    <input type="file" id="tax_file" hidden onchange="handleTaxImport(this)">
</div>

<div class="view">
    <div class="card" style="flex: 1.2;">
        <div style="font-weight:700; margin-bottom:15px; display:flex; justify-content:space-between;">
            <span>å®¢æˆ·æ¬ æ¬¾æ’è¡Œ</span>
            <span id="sync_status" style="font-size:12px; color:var(--success); font-weight:400;">â— äº‘ç«¯å·²è¿æ¥</span>
        </div>
        <div class="stat-bar">
            <div class="stat-item">æ€»å¼€ç¥¨<div class="stat-val" id="total_i">0.00</div></div>
            <div class="stat-item">æ€»å›æ¬¾<div class="stat-val" id="total_p" style="color:var(--success)">0.00</div></div>
            <div class="stat-item">æ€»æ¬ æ¬¾<div class="stat-val" id="total_b" style="color:var(--danger)">0.00</div></div>
        </div>
        <div style="overflow-y:auto; flex:1;">
            <table>
                <thead><tr><th>å®¢æˆ·åç§°</th><th>å¼€ç¥¨é¢</th><th>å·²ä»˜</th><th style="text-align:right;">å¾…ä»˜</th></tr></thead>
                <tbody id="main_body"></tbody>
            </table>
        </div>
    </div>

    <div class="card" style="flex: 0.8;">
        <div id="detail_title" style="font-weight:700; margin-bottom:15px; color:var(--accent)">è¯·é€‰æ‹©å·¦ä¾§å®¢æˆ·æŸ¥çœ‹è¯¦æƒ…</div>
        
        <div id="input_area" style="display:none; background:#f5faff; padding:15px; border-radius:10px; margin-bottom:20px;">
            <div style="font-size:13px; font-weight:600; margin-bottom:10px;">å¿«é€Ÿå½•å…¥è¯¥å®¢æˆ·å›æ¬¾ï¼š</div>
            <input type="number" id="p_amt" class="apple-input" placeholder="å›æ¬¾é‡‘é¢">
            <input type="date" id="p_day" class="apple-input">
            <button class="apple-btn" style="width:100%" id="btn_save" onclick="addPay()">ç¡®è®¤è®°è´¦å¹¶åŒæ­¥</button>
        </div>

        <div style="font-weight:600; font-size:13px; margin-bottom:10px;">å›æ¬¾å†å²æ˜ç»†ï¼š</div>
        <div style="overflow-y:auto; flex:1;">
            <table>
                <thead><tr><th>æ—¥æœŸ</th><th style="text-align:right;">é‡‘é¢</th></tr></thead>
                <tbody id="detail_body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = "https://vjelnswcmypvypegqxrb.supabase.co"; 
    const SUPABASE_KEY = "sb_publishable_BUhR8WlHyaOHnK5IjEGKtw_lcre2gFT";
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let INVOICES = JSON.parse(localStorage.getItem('HF_INV')) || [];
    let CLIS = JSON.parse(localStorage.getItem('HF_CLIS')) || {};
    let PAYMENTS = [];
    let CURRENT_TID = null;

    // --- æ ¸å¿ƒï¼šè§£å†³ä¸æ›´æ–°çš„é—®é¢˜ ---
    // ç›‘å¬äº‘ç«¯æ•°æ®å˜åŒ–ï¼Œä¸€æ—¦æœ‰å˜åŠ¨ç«‹åˆ»åˆ·æ–°ç•Œé¢
    _supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'payments' }, () => {
        fetchPayments();
    }).subscribe();

    async function fetchPayments() {
        document.getElementById('sync_status').innerText = "â—‹ åŒæ­¥ä¸­...";
        const { data, error } = await _supabase.from('payments').select('*').order('pay_date', { ascending: false });
        if (!error) {
            PAYMENTS = data;
            render();
            if (CURRENT_TID) showDetail(CURRENT_TID);
            document.getElementById('sync_status').innerText = "â— äº‘ç«¯å·²åŒæ­¥";
        }
    }

    async function addPay() {
        const amt = parseFloat(document.getElementById('p_amt').value);
        const day = document.getElementById('p_day').value;
        if (!CURRENT_TID || isNaN(amt) || !day) return alert('è¯·å¡«å…¨ä¿¡æ¯');

        const btn = document.getElementById('btn_save');
        btn.disabled = true; btn.innerText = 'åŒæ­¥ä¸­...';

        const { error } = await _supabase.from('payments').insert([
            { client_name: CLIS[CURRENT_TID], amount: amt, pay_date: day, client_id: CURRENT_TID }
        ]);
        
        if (error) { alert('å¤±è´¥:' + error.message); } 
        else { document.getElementById('p_amt').value = ''; }
        btn.disabled = false; btn.innerText = 'ç¡®è®¤è®°è´¦å¹¶åŒæ­¥';
    }

    function handleTaxImport(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            json.forEach(row => {
                const invId = String(row['æ•°ç”µç¥¨å·ç '] || row['æ•°ç”µå‘ç¥¨å·ç '] || "");
                const tid = String(row['è´­æ–¹è¯†åˆ«å·'] || row['è´­ä¹°æ–¹è¯†åˆ«å·'] || "");
                if (invId && tid) {
                    CLIS[tid] = row['è´­ä¹°æ–¹åç§°'] || row['è´­æ–¹åç§°'];
                    if (!INVOICES.find(x => x.id === invId)) {
                        INVOICES.push({ id: invId, tid: tid, amt: parseFloat(row['ä»·ç¨åˆè®¡'] || 0) });
                    }
                }
            });
            localStorage.setItem('HF_INV', JSON.stringify(INVOICES));
            localStorage.setItem('HF_CLIS', JSON.stringify(CLIS));
            render();
            alert('å¯¼å…¥æˆåŠŸ');
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function showDetail(tid) {
        CURRENT_TID = tid;
        document.getElementById('detail_title').innerText = "å½“å‰å®¢æˆ·ï¼š" + CLIS[tid];
        document.getElementById('input_area').style.display = 'block';
        
        const dBody = document.getElementById('detail_body');
        dBody.innerHTML = '';
        
        const filtered = PAYMENTS.filter(p => p.client_id === tid || p.client_name === CLIS[tid]);
        filtered.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${p.pay_date}</td><td style="text-align:right;">${parseFloat(p.amount).toLocaleString()}</td>`;
            dBody.appendChild(tr);
        });

        // é«˜äº®å·¦ä¾§è¡Œ
        document.querySelectorAll('#main_body tr').forEach(tr => tr.classList.remove('active-row'));
        const activeTr = document.querySelector(`tr[data-tid="${tid}"]`);
        if (activeTr) activeTr.classList.add('active-row');
    }

    function render() {
        const mBody = document.getElementById('main_body');
        mBody.innerHTML = '';
        let sums = {};
        INVOICES.forEach(i => {
            if (!sums[i.tid]) sums[i.tid] = { i: 0, p: 0 };
            sums[i.tid].i += i.amt;
        });
        PAYMENTS.forEach(p => {
            const tid = Object.keys(CLIS).find(k => CLIS[k] === p.client_name) || p.client_id;
            if (tid && sums[tid]) sums[tid].p += parseFloat(p.amount);
        });

        let tI = 0, tP = 0;
        Object.keys(sums).sort((a,b) => (sums[b].i-sums[b].p)-(sums[a].i-sums[a].p)).forEach(tid => {
            const bal = sums[tid].i - sums[tid].p;
            tI += sums[tid].i; tP += sums[tid].p;
            const tr = document.createElement('tr');
            tr.setAttribute('data-tid', tid);
            tr.onclick = () => showDetail(tid);
            tr.innerHTML = `<td>${CLIS[tid]}</td><td>${sums[tid].i.toLocaleString()}</td><td>${sums[tid].p.toLocaleString()}</td><td style="text-align:right; font-weight:700; color:${bal>0?'var(--danger)':'#333'}">${bal.toLocaleString()}</td>`;
            mBody.appendChild(tr);
        });

        document.getElementById('total_i').innerText = tI.toLocaleString();
        document.getElementById('total_p').innerText = tP.toLocaleString();
        document.getElementById('total_b').innerText = (tI - tP).toLocaleString();
    }

    document.getElementById('p_day').valueAsDate = new Date();
    fetchPayments();
    // æ¯ 5 ç§’å¼ºåˆ¶æ‹‰å–ä¸€æ¬¡ï¼Œç¡®ä¿æ‰‹æœºç«¯ç»å¯¹æ›´æ–°
    setInterval(fetchPayments, 5000);
</script>
</body>
</html>
</body>
</html>
